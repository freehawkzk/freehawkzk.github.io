<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="utf-8">
  

  
  <title>Hexo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta property="og:type" content="website">
<meta property="og:title" content="Hexo">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:locale" content="default">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Hexo">
  
    <link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
</head>
</html>
<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Hexo</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://yoursite.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-UE4源代码分析/【UE4源代码分析】-003 临界区/【UE4源代码分析】-003 临界区" class="article article-type-post" itemscope="" itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/10/28/UE4源代码分析/【UE4源代码分析】-003 临界区/【UE4源代码分析】-003 临界区/" class="article-date">
  <time datetime="2018-10-27T16:34:35.000Z" itemprop="datePublished">2018-10-28</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/10/28/UE4源代码分析/【UE4源代码分析】-003 临界区/【UE4源代码分析】-003 临界区/">【UE4源代码分析】-003 临界区</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="1、临界区"><a href="#1、临界区" class="headerlink" title="1、临界区"></a>1、临界区</h2><p>&emsp;&emsp;<strong>临界区</strong>指的是一个访问共用资源（例如：共用设备或是共用存储器）的程序片段，而这些共用资源又无法同时被多个线程访问的特性。当有线程进入临界区段时，其他线程或是进程必须等待（例如：bounded waiting 等待法），有一些同步的机制必须在临界区段的进入点与离开点实现，以确保这些共用资源是被互斥获得使用。<br>&emsp;&emsp;简单来说，临界区是一种锁，每次只允许一把钥匙对锁进行加锁操作。程序在使用临界资源之前需要使用自己的钥匙对锁进行加锁操作。加锁操作时，先检查锁是否处于锁定操作，如果处于锁定状态，那么需要等待锁被原加锁者解锁或超时。加锁成功后，程序可以使用临界资源。在使用完成之后需要使用钥匙对资源进行解锁。从而保证，同一时刻只有一个用户能够对临界资源进行访问。<br>&emsp;&emsp;<strong>临界区</strong>实现的是一种<strong>互斥</strong>的保护。</p>
<h2 id="2、Windows临界区"><a href="#2、Windows临界区" class="headerlink" title="2、Windows临界区"></a>2、Windows临界区</h2><p>&emsp;&esmp;windows提供了一种<strong>CRITICAL_SECTION</strong>结构，并提供相关操作函数来实现相关功能，主要包括：<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//初始化临界区</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> WINAPI <span class="title">InitializeCriticalSection</span><span class="params">(LPCRITICAL_SECTION lpCriticalSection)</span></span>;</span><br><span class="line"><span class="comment">//带自旋次数的初始化临界区</span></span><br><span class="line"><span class="function">BOOL WINAPI <span class="title">InitializeCriticalSectionAndSpinCount</span><span class="params">(LPCRITICAL_SECTION lpCriticalSection, DWORD dwSpinCount)</span></span>;</span><br><span class="line"><span class="comment">//设置临界区的自旋次数</span></span><br><span class="line"><span class="function">DWORD WINAPI <span class="title">SetCriticalSectionSpinCount</span><span class="params">(LPCRITICAL_SECTION lpCriticalSection, DWORD dwSpinCount)</span></span>;</span><br><span class="line"><span class="comment">//尝试进入临界区</span></span><br><span class="line"><span class="function">BOOL WINAPI <span class="title">TryEnterCriticalSection</span><span class="params">(LPCRITICAL_SECTION lpCriticalSection)</span></span>;</span><br><span class="line"><span class="comment">//进入临界区</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> WINAPI <span class="title">EnterCriticalSection</span><span class="params">(LPCRITICAL_SECTION lpCriticalSection)</span></span>;</span><br><span class="line"><span class="comment">//离开临界区</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> WINAPI <span class="title">LeaveCriticalSection</span><span class="params">(LPCRITICAL_SECTION lpCriticalSection)</span></span>;</span><br><span class="line"><span class="comment">//删除临界区，释放临界区</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> WINAPI <span class="title">DeleteCriticalSection</span><span class="params">(LPCRITICAL_SECTION lpCriticalSection)</span></span>;</span><br></pre></td></tr></table></figure></p>
<p>&emsp;&emsp;<strong>CRITICAL_SECTION</strong>并不是windows系统的核心对象，不具备名称。因此，临界区只能用于单个进程的多个线程之间的同步，对于进程之间的通信和同步无能为力。</p>
<h2 id="3、UE4中的临界区"><a href="#3、UE4中的临界区" class="headerlink" title="3、UE4中的临界区"></a>3、UE4中的临界区</h2><p>&emsp;&emsp;在UE4中，Engine\Source\Runtime\Core\Public\Windows\WindowsCriticalSection.h文件提供了UE4中临界区的定义，主要包括<code>FWindowsCriticalSection</code>和<code>FWindowsSystemWideCriticalSection</code>两种。</p>
<h3 id="3-1-FWindowsCriticalSection"><a href="#3-1-FWindowsCriticalSection" class="headerlink" title="3.1 FWindowsCriticalSection"></a>3.1 FWindowsCriticalSection</h3><p>&emsp;&emsp;<code>FWindowsCriticalSection</code>是UE4对windows操作系统中<code>CRITICAL_SECTION</code>结构的封装，提供无命名的临界区资源锁以及相关操作功能。<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * This is the Windows version of a critical section. It uses an aggregate</span></span><br><span class="line"><span class="comment"> * CRITICAL_SECTION to implement its locking.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FWindowsCriticalSection</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">	<span class="comment">//私有成员，windows普通的CRITICAL_SECTION变量</span></span><br><span class="line">	Windows::CRITICAL_SECTION CriticalSection;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line"></span><br><span class="line">	<span class="comment">//构造函数，自旋次数初始值设置为4000.</span></span><br><span class="line">	<span class="function">FORCEINLINE <span class="title">FWindowsCriticalSection</span><span class="params">()</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		CA_SUPPRESS(<span class="number">28125</span>);</span><br><span class="line">		<span class="comment">//初始化临界区资源</span></span><br><span class="line">		Windows::InitializeCriticalSection(&amp;CriticalSection);</span><br><span class="line">		Windows::SetCriticalSectionSpinCount(&amp;CriticalSection,<span class="number">4000</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//析构函数，释放临界区</span></span><br><span class="line">	FORCEINLINE ~FWindowsCriticalSection()</span><br><span class="line">	&#123;</span><br><span class="line">		Windows::DeleteCriticalSection(&amp;CriticalSection);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//加锁操作，采用先尝试，后进入的流程</span></span><br><span class="line">	<span class="function">FORCEINLINE <span class="keyword">void</span> <span class="title">Lock</span><span class="params">()</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		<span class="comment">// Spin first before entering critical section, causing ring-0 transition and context switch.</span></span><br><span class="line">		<span class="keyword">if</span>(Windows::TryEnterCriticalSection(&amp;CriticalSection) == <span class="number">0</span> )</span><br><span class="line">		&#123;</span><br><span class="line">			Windows::EnterCriticalSection(&amp;CriticalSection);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//尝试加锁，当前临界区能够被当前线程加锁，则返回true，否则返回false</span></span><br><span class="line">	<span class="function">FORCEINLINE <span class="keyword">bool</span> <span class="title">TryLock</span><span class="params">()</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (Windows::TryEnterCriticalSection(&amp;CriticalSection))</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//解锁</span></span><br><span class="line">	<span class="function">FORCEINLINE <span class="keyword">void</span> <span class="title">Unlock</span><span class="params">()</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		Windows::LeaveCriticalSection(&amp;CriticalSection);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="comment">//确保临界区无法被复制和赋值</span></span><br><span class="line">	FWindowsCriticalSection(<span class="keyword">const</span> FWindowsCriticalSection&amp;);</span><br><span class="line">	FWindowsCriticalSection&amp; <span class="keyword">operator</span>=(<span class="keyword">const</span> FWindowsCriticalSection&amp;);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p>&emsp;&emsp;通过将<code>FWindowsCriticalSection::FWindowsCriticalSection(const FWindowsCriticalSection&amp;)</code>和<code>FWindowsCriticalSection&amp; FWindowsCriticalSection::operator=(const FWindowsCriticalSection&amp;)</code>声明为私有函数，从而确保临界区资源锁无法被复制和赋值。</p>
<h3 id="3-2-FWindowsSystemWideCriticalSection"><a href="#3-2-FWindowsSystemWideCriticalSection" class="headerlink" title="3.2 FWindowsSystemWideCriticalSection"></a>3.2 FWindowsSystemWideCriticalSection</h3><p>&emsp;&emsp;除了无法用于进程间同步的普通临界区之外，UE4还通过Mutex模仿了一个可用于进程间同步的临界区<code>FWindowsSystemWideCriticalSection</code>。<br>&emsp;&emsp;Mutex是互斥器，在windows系统中是系统的核心对象，可以命名，并通过名称获取已经存在的对象实例。基于以上特性，UE4通过Mutex的封装，实现了能够用于进程间线程同步的<code>FWindowsSystemWideCriticalSection</code>，其类定义如下：<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** System-Wide Critical Section for windows using mutex */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CORE_API</span> <span class="title">FWindowsSystemWideCriticalSection</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="comment">//构造函数，创建并尝试获取命名Mutex</span></span><br><span class="line">	<span class="function"><span class="keyword">explicit</span> <span class="title">FWindowsSystemWideCriticalSection</span><span class="params">(<span class="keyword">const</span> class FString&amp; InName, FTimespan InTimeout = FTimespan::Zero())</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//析构函数，如果当前持有锁的话释放锁</span></span><br><span class="line">	~FWindowsSystemWideCriticalSection();</span><br><span class="line"></span><br><span class="line">	<span class="comment">//检查锁当前是否能够获取，如果能够获取或者前一个拥有着在未释放锁的情况下结束了，返回true，否则返回false。</span></span><br><span class="line">	<span class="function"><span class="keyword">bool</span> <span class="title">IsValid</span><span class="params">()</span> <span class="keyword">const</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//释放锁</span></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">Release</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="comment">//防止锁被拷贝和赋值</span></span><br><span class="line">	FWindowsSystemWideCriticalSection(<span class="keyword">const</span> FWindowsSystemWideCriticalSection&amp;);</span><br><span class="line">	FWindowsSystemWideCriticalSection&amp; <span class="keyword">operator</span>=(<span class="keyword">const</span> FWindowsSystemWideCriticalSection&amp;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">	Windows::HANDLE Mutex;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2018/10/28/UE4源代码分析/【UE4源代码分析】-003 临界区/【UE4源代码分析】-003 临界区/" data-id="cjnroz8p300066l9spx4ro9xe" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-UE4源代码分析/【UE4源代码分析】-007 仿UE4使用ADO进行数据库操作/【UE4源代码分析】-007 仿UE4使用ADO进行数据库操作" class="article article-type-post" itemscope="" itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/10/28/UE4源代码分析/【UE4源代码分析】-007 仿UE4使用ADO进行数据库操作/【UE4源代码分析】-007 仿UE4使用ADO进行数据库操作/" class="article-date">
  <time datetime="2018-10-27T16:34:35.000Z" itemprop="datePublished">2018-10-28</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/10/28/UE4源代码分析/【UE4源代码分析】-007 仿UE4使用ADO进行数据库操作/【UE4源代码分析】-007 仿UE4使用ADO进行数据库操作/">【UE4源代码分析】-007 仿UE4使用ADO进行数据库操作</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>&emsp;&emsp;由于工作的关系，主要开发平台是在windows上。在一些小项目中需要使用数据库时，经常会先使用ACCESS制作项目原型，等验证之后再转移到MySQL下。通常使用的连接Access的方式是ADO，由于公司以往没有对ADO进行封装，使用时颇为不便。<br>&emsp;&emsp;最近看UE4的源代码的时候发现其中有对ADO的一个封装，阅读之后觉得挺好，因此想着把这部分从UE4中独立出来，看看在普通场景下的应用效果如何。<br>[TOC]</p>
<h2 id="1、UE4的DataBase支持"><a href="#1、UE4的DataBase支持" class="headerlink" title="1、UE4的DataBase支持"></a>1、UE4的DataBase支持</h2><p>&emsp;&emsp;<strong>UE4</strong>对数据库的支持主要使用<code>DatabaseSupport</code> Module。其实现文件在<code>\Engine\Source\Runtime\DatabaseSupport\</code>路径中，主要包括Database.h\Database.cpp,DatabaseSupport.h\DatabaseSupport.cpp四个文件，其中DatabaseSupport.h\DatabaseSupport.cpp主要用于实现数据库支持模块，具体的数据库操作都实现在Database.h\Database.cpp中。<br>&emsp;&emsp;因此，在这里我主要讨论Database.h\Database.cpp这两个文件。<br>&emsp;&emsp;在Database.h文件开头处，首先进行了三个宏定义：<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Whether to compile in support for database connectivity and SQL execution.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> WITH_DATABASE_SUPPORT</span></span><br><span class="line">	<span class="meta">#<span class="meta-keyword">define</span> WITH_DATABASE_SUPPORT (!UE_BUILD_MINIMAL &amp;&amp; !UE_BUILD_SHIPPING)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Only use ADO on windows, if support is enabled and not for shipping games.</span></span><br><span class="line"><span class="comment">// @todo clang: #import is not supported by Clang on Windows platform, but we currently need this for ADO symbol importing.  For now we disable ADO support in Clang builds.</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> USE_ADO_INTEGRATION (PLATFORM_WINDOWS &amp;&amp; !(UE_BUILD_SHIPPING &amp;&amp; WITH_EDITOR) &amp;&amp; WITH_DATABASE_SUPPORT &amp;&amp; !PLATFORM_COMPILER_CLANG)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> USE_REMOTE_INTEGRATION (!USE_ADO_INTEGRATION &amp;&amp; !(UE_BUILD_SHIPPING &amp;&amp; WITH_EDITOR) &amp;&amp; WITH_DATABASE_SUPPORT &amp;&amp; !PLATFORM_COMPILER_CLANG)</span></span><br></pre></td></tr></table></figure></p>
<p>&emsp;&emsp;从第一个宏<code>WITH_DATABASE_SUPPORT</code>可以发现，UE4默认情况下，只有在非发行模式并且是非最小模式编译时才能启动数据库支持。<br>&emsp;&emsp;第二个宏<code>USE_ADO_INTEGRATION</code>可以理解为启用ADO数据库支持需要同时满足四个条件：</p>
<ul>
<li>Windows平台；</li>
<li>不是带编辑器的发行版；</li>
<li>启用了数据库支持；</li>
<li>编译器不是CLang。（<em>CLang编译器在windows平台上不支持#import操作，目前暂时禁用了windows平台上CLang编译时的ADO支持</em>）。<br>&emsp;&emsp;第三个宏<code>USE_REMOTE_INTEGRATION</code>是启用远程数据库支持的宏，在这里我们不做详细讨论。<h2 id="2、UE4-ADO封装解析"><a href="#2、UE4-ADO封装解析" class="headerlink" title="2、UE4 ADO封装解析"></a>2、UE4 ADO封装解析</h2>&emsp;&emsp;一般的数据库操作主要关心连接以及记录集，在UE4中，分别为连接和记录集定义了支持的类<code>FDataBaseRecordSet</code>和<code>FDataBaseConnection</code>类，为了方便操作记录集，还定义了辅助结构<code>FDatabaseColumnInfo</code>和内部迭代器类<code>TIterator</code>。在以上这些类的基础上，分别为ADO操作数据库派生了记录集类和数据库连接类。<br><img src="/2018/10/28/UE4源代码分析/【UE4源代码分析】-007 仿UE4使用ADO进行数据库操作/【UE4源代码分析】-007 仿UE4使用ADO进行数据库操作/007-Database-RecordSet.png"><div align="center">图1 UE4数据库操作记录集类图</div>

</li>
</ul>
<p><img src="/2018/10/28/UE4源代码分析/【UE4源代码分析】-007 仿UE4使用ADO进行数据库操作/【UE4源代码分析】-007 仿UE4使用ADO进行数据库操作/007-Database-Connection.png"></p>
<div algin="center">图2 UE4数据库操作数据库连接类图</div>

<h3 id="2-1-基类"><a href="#2-1-基类" class="headerlink" title="2.1 基类"></a>2.1 基类</h3><h4 id="2-1-1-FDatabaseColumnInfo"><a href="#2-1-1-FDatabaseColumnInfo" class="headerlink" title="2.1.1 FDatabaseColumnInfo"></a>2.1.1 FDatabaseColumnInfo</h4><p>&emsp;&emsp;<code>FDatabaseColumnInfo</code>主要用于辅助操作记录集，用于记录记录集中列的名称和数据类型。<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**   </span></span><br><span class="line"><span class="comment"> * This struct holds info relating to a column.  Specifically, we need to get back  </span></span><br><span class="line"><span class="comment"> * certain meta info from a RecordSet so we can "Get" data from it.  </span></span><br><span class="line"><span class="comment"> */</span>  </span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">FDatabaseColumnInfo</span>  </span></span><br><span class="line"><span class="class">&#123;</span>  </span><br><span class="line">	<span class="comment">/** Default constructor **/</span>  </span><br><span class="line">	FDatabaseColumnInfo(): DataType(DBT_UNKOWN) &#123;&#125;  </span><br><span class="line"></span><br><span class="line">	<span class="comment">/** The name of the column **/</span>  </span><br><span class="line">	FString ColumnName;  </span><br><span class="line"></span><br><span class="line">	<span class="comment">/** This is the type of data in this column.  (e.g. so you can do GetFloat or GetInt on the column **/</span>  </span><br><span class="line">	EDataBaseUnrealTypes DataType;  </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="keyword">bool</span> <span class="keyword">operator</span>==(<span class="keyword">const</span> FDatabaseColumnInfo&amp; OtherFDatabaseColumnInfo) <span class="keyword">const</span>  </span><br><span class="line">	&#123;  </span><br><span class="line">		<span class="keyword">return</span> (ColumnName==OtherFDatabaseColumnInfo.ColumnName) &amp;&amp; (DataType==OtherFDatabaseColumnInfo.DataType);  </span><br><span class="line">	&#125;  </span><br><span class="line"></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p>&emsp;&emsp;在<code>FDataBaseRecordSet::GetColumnNames</code>接口中，返回的是<code>FDatabaseColumnInfo</code>对象组成的数组。</p>
<h4 id="2-1-2-FDataBaseRecordSet"><a href="#2-1-2-FDataBaseRecordSet" class="headerlink" title="2.1.2 FDataBaseRecordSet"></a>2.1.2 FDataBaseRecordSet</h4><p>&emsp;&emsp;<code>FDataBaseRecordSet</code>类是数据库记录集的基类，主要定义了数据库记录集对象需要具备的接口函数，并实现了一个空版本的接口，并为遍历记录集提供了迭代器。<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Empty base class for iterating over database records returned via query. Used on platforms not supporting</span></span><br><span class="line"><span class="comment"> * a direct database connection.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FDataBaseRecordSet</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">	<span class="comment">// Protected functions used internally for iteration.</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line">	<span class="comment">/** Moves to the first record in the set. */</span></span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">MoveToFirst</span><span class="params">()</span></span></span><br><span class="line"><span class="function">	</span>&#123;&#125;</span><br><span class="line">	<span class="comment">/** Moves to the next record in the set. */</span></span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">MoveToNext</span><span class="params">()</span></span></span><br><span class="line"><span class="function">	</span>&#123;&#125;</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Returns whether we are at the end.</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * @return true if at the end, false otherwise</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">bool</span> <span class="title">IsAtEnd</span><span class="params">()</span> <span class="keyword">const</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line"></span><br><span class="line">	<span class="comment">/** </span></span><br><span class="line"><span class="comment">	 *   Returns a count of the number of records in the record set</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> int32 <span class="title">GetRecordCount</span><span class="params">()</span> <span class="keyword">const</span></span></span><br><span class="line"><span class="function">	</span>&#123; </span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Returns a string associated with the passed in field/ column for the current row.</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * @param	Column	Name of column to retrieve data for in current row</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> FString <span class="title">GetString</span><span class="params">( <span class="keyword">const</span> TCHAR* Column )</span> <span class="keyword">const</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		<span class="keyword">return</span> TEXT(<span class="string">"No database connection compiled in."</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Returns an integer associated with the passed in field/ column for the current row.</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * @param	Column	Name of column to retrieve data for in current row</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> int32 <span class="title">GetInt</span><span class="params">( <span class="keyword">const</span> TCHAR* Column )</span> <span class="keyword">const</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Returns a float associated with the passed in field/ column for the current row.</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * @param	Column	Name of column to retrieve data for in current row</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">float</span> <span class="title">GetFloat</span><span class="params">( <span class="keyword">const</span> TCHAR* Column )</span> <span class="keyword">const</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Returns a int64 associated with the passed in field/ column for the current row.</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * @param	Column	Name of column to retrieve data for in current row</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> int64 <span class="title">GetBigInt</span><span class="params">( <span class="keyword">const</span> TCHAR* Column )</span> <span class="keyword">const</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**  </span></span><br><span class="line"><span class="comment">      * Returns the set of column names for this Recordset.  This is useful for determining  </span></span><br><span class="line"><span class="comment">      * what you can actually ask the record set for without having to hard code those ahead of time.  </span></span><br><span class="line"><span class="comment">      */</span>  </span><br><span class="line">     <span class="keyword">virtual</span> TArray&lt;FDatabaseColumnInfo&gt; GetColumnNames() <span class="keyword">const</span>  </span><br><span class="line">     &#123;  </span><br><span class="line">          TArray&lt;FDatabaseColumnInfo&gt; Retval;  </span><br><span class="line">          <span class="keyword">return</span> Retval;  </span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/** Virtual destructor as class has virtual functions. */</span></span><br><span class="line">	<span class="keyword">virtual</span> ~FDataBaseRecordSet()</span><br><span class="line">	&#123;&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Iterator helper class based on FObjectIterator.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="class"><span class="keyword">class</span> <span class="title">TIterator</span></span></span><br><span class="line"><span class="class">	&#123;</span></span><br><span class="line">	<span class="keyword">public</span>:</span><br><span class="line">		<span class="comment">/** </span></span><br><span class="line"><span class="comment">		 * Initialization constructor.</span></span><br><span class="line"><span class="comment">		 *</span></span><br><span class="line"><span class="comment">		 * @param	InRecordSet		RecordSet to iterate over</span></span><br><span class="line"><span class="comment">		 */</span></span><br><span class="line">		TIterator( FDataBaseRecordSet* InRecordSet )</span><br><span class="line">		: RecordSet( InRecordSet )</span><br><span class="line">		&#123;</span><br><span class="line">			RecordSet-&gt;MoveToFirst();</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">/** </span></span><br><span class="line"><span class="comment">		 * operator++ used to iterate to next element.</span></span><br><span class="line"><span class="comment">		 */</span></span><br><span class="line">		<span class="keyword">void</span> <span class="keyword">operator</span>++()</span><br><span class="line">		&#123; </span><br><span class="line">			RecordSet-&gt;MoveToNext();	</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">/** Conversion to "bool" returning true if the iterator is valid. */</span></span><br><span class="line">		<span class="function">FORCEINLINE <span class="keyword">explicit</span> <span class="keyword">operator</span> <span class="title">bool</span><span class="params">()</span> <span class="keyword">const</span></span></span><br><span class="line"><span class="function">		</span>&#123; </span><br><span class="line">			<span class="keyword">return</span> !RecordSet-&gt;IsAtEnd(); </span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">/** inverse of the "bool" operator */</span></span><br><span class="line">		FORCEINLINE <span class="keyword">bool</span> <span class="keyword">operator</span> !() <span class="keyword">const</span> </span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">return</span> !(<span class="keyword">bool</span>)*<span class="keyword">this</span>;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Access operators</span></span><br><span class="line">		FORCEINLINE FDataBaseRecordSet* <span class="keyword">operator</span>*() <span class="keyword">const</span></span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">return</span> RecordSet;</span><br><span class="line">		&#125;</span><br><span class="line">		FORCEINLINE FDataBaseRecordSet* <span class="keyword">operator</span>-&gt;() <span class="keyword">const</span></span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">return</span> RecordSet;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">protected</span>:</span><br><span class="line">		<span class="comment">/** Database record set being iterated over. */</span></span><br><span class="line">		FDataBaseRecordSet* RecordSet;</span><br><span class="line">	&#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<h4 id="2-1-3-FDataBaseConnection"><a href="#2-1-3-FDataBaseConnection" class="headerlink" title="2.1.3 FDataBaseConnection"></a>2.1.3 FDataBaseConnection</h4><p>&emsp;&emsp;<code>FDataBaseConnection</code>是数据库连接类的基类，主要定义了数据库操作的连接、关闭、执行SQL语句等接口。<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Empty base class for database access via executing SQL commands. Used on platforms not supporting</span></span><br><span class="line"><span class="comment"> * a direct database connection.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FDataBaseConnection</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="comment">/** Virtual destructor as we have virtual functions. */</span></span><br><span class="line">	<span class="keyword">virtual</span> ~FDataBaseConnection() </span><br><span class="line">	&#123;&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Opens a connection to the database.</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * @param	ConnectionString	Connection string passed to database layer</span></span><br><span class="line"><span class="comment">	 * @param   RemoteConnectionIP  The IP address which the RemoteConnection should connect to</span></span><br><span class="line"><span class="comment">	 * @param   RemoteConnectionStringOverride  The connection string which the RemoteConnection is going to utilize</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * @return	true if connection was successfully established, false otherwise</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">bool</span> <span class="title">Open</span><span class="params">( <span class="keyword">const</span> TCHAR* ConnectionString, <span class="keyword">const</span> TCHAR* RemoteConnectionIP, <span class="keyword">const</span> TCHAR* RemoteConnectionStringOverride )</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Closes connection to database.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">Close</span><span class="params">()</span></span></span><br><span class="line"><span class="function">	</span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Executes the passed in command on the database.</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * @param CommandString		Command to execute</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * @return true if execution was successful, false otherwise</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">bool</span> <span class="title">Execute</span><span class="params">( <span class="keyword">const</span> TCHAR* CommandString )</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Executes the passed in command on the database. The caller is responsible for deleting</span></span><br><span class="line"><span class="comment">	 * the created RecordSet.</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * @param CommandString		Command to execute</span></span><br><span class="line"><span class="comment">	 * @param RecordSet			Reference to recordset pointer that is going to hold result</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * @return true if execution was successful, false otherwise</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">bool</span> <span class="title">Execute</span><span class="params">( <span class="keyword">const</span> TCHAR* CommandString, FDataBaseRecordSet*&amp; RecordSet )</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		RecordSet = <span class="literal">nullptr</span>;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Static function creating appropriate database connection object.</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * @return	instance of platform specific database connection object</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function">DATABASESUPPORT_API <span class="keyword">static</span> FDataBaseConnection* <span class="title">CreateObject</span><span class="params">()</span></span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<h3 id="2-2-派生类"><a href="#2-2-派生类" class="headerlink" title="2.2 派生类"></a>2.2 派生类</h3><p>&emsp;&emsp;基类实现的都是空操作，因此，需要对基类进行有效的派生之后才能用于实际使用。UE4的ADO支持就是通过对基类的有效派生，将数据库操作与ADO操作数据库相结合，完成数据库的操作。</p>
<h4 id="2-2-1-ADO的引入"><a href="#2-2-1-ADO的引入" class="headerlink" title="2.2.1 ADO的引入"></a>2.2.1 ADO的引入</h4><p>&emsp;&emsp;通常情况下，在C++中使用ADO操作数据库都会通过<code>#import</code>指令引入msado15.dll，UE4也不例外引入了msado15.dll。不同之处在于引入时的文件路径设置。<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Using import allows making use of smart pointers easily. Please post to the list if a workaround such as</span></span><br><span class="line"><span class="comment">// using %COMMONFILES% works to hide the localization issues and non default program file folders.</span></span><br><span class="line"><span class="comment">//#import "C:\Program files\Common Files\System\Ado\msado15.dll" rename("EOF", "ADOEOF")</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> <span class="meta-keyword">warning</span>(push)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> <span class="meta-keyword">warning</span>(disable: 4471) <span class="comment">// a forward declaration of an unscoped enumeration must have an underlying type (int assumed)</span></span></span><br><span class="line"><span class="meta">#import <span class="meta-string">"System\ADO\msado15.dll"</span> rename(<span class="meta-string">"EOF"</span>, <span class="meta-string">"ADOEOF"</span>) <span class="comment">//lint !e322</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> <span class="meta-keyword">warning</span>(pop)</span></span><br></pre></td></tr></table></figure></p>
<p>&emsp;&emsp;一般情况下，会采用<code>//#import &quot;C:\Program files\Common Files\System\Ado\msado15.dll&quot; rename(&quot;EOF&quot;, &quot;ADOEOF&quot;)</code>的方式，采用绝对路径的方式引入，但由于系统安装不同的原因，可能导致msado15.dll并不在C盘下，而导致运行编译出错。</p>
<h4 id="2-2-2-FADODataBaseRecordSet"><a href="#2-2-2-FADODataBaseRecordSet" class="headerlink" title="2.2.2 FADODataBaseRecordSet"></a>2.2.2 FADODataBaseRecordSet</h4><p>&emsp;&emsp;<code>FADODataBaseRecordSet</code>类派生自<code>FDataBaseRecordSet</code>类，主要完成ADO记录集的遍历、字段数据的提取的功能。限于篇幅，文章中对类的实现进行了删减，读者可以自行查看UE4的源代码。<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ADO implementation of database record set.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FADODataBaseRecordSet</span> :</span> <span class="keyword">public</span> FDataBaseRecordSet</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">	ADODB::_RecordsetPtr ADORecordSet;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line">	<span class="comment">/** Moves to the first record in the set. */</span></span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">MoveToFirst</span><span class="params">()</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">/** Moves to the next record in the set. */</span></span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">MoveToNext</span><span class="params">()</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Returns whether we are at the end.</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * @return true if at the end, false otherwise</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">bool</span> <span class="title">IsAtEnd</span><span class="params">()</span> <span class="keyword">const</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		<span class="keyword">return</span> !!ADORecordSet-&gt;ADOEOF;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line"></span><br><span class="line">	<span class="comment">/** </span></span><br><span class="line"><span class="comment">	 *   Returns a count of the number of records in the record set</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> int32 <span class="title">GetRecordCount</span><span class="params">()</span> <span class="keyword">const</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		<span class="keyword">return</span> ADORecordSet-&gt;RecordCount;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Returns a string associated with the passed in field/ column for the current row.</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * @param	Column	Name of column to retrieve data for in current row</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> FString <span class="title">GetString</span><span class="params">( <span class="keyword">const</span> TCHAR* Column )</span> <span class="keyword">const</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		<span class="keyword">return</span> ReturnString;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Returns an integer associated with the passed in field/ column for the current row.</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * @param	Column	Name of column to retrieve data for in current row</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> int32 <span class="title">GetInt</span><span class="params">( <span class="keyword">const</span> TCHAR* Column )</span> <span class="keyword">const</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		<span class="keyword">return</span> ReturnValue;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Returns a float associated with the passed in field/ column for the current row.</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * @param	Column	Name of column to retrieve data for in current row</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">float</span> <span class="title">GetFloat</span><span class="params">( <span class="keyword">const</span> TCHAR* Column )</span> <span class="keyword">const</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		<span class="keyword">return</span> ReturnValue;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Returns an int64 associated with the passed in field/ column for the current row.</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * @param	Column	Name of column to retrieve data for in current row</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> int64 <span class="title">GetBigInt</span><span class="params">( <span class="keyword">const</span> TCHAR* Column )</span> <span class="keyword">const</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		<span class="keyword">return</span> ReturnValue;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Returns the set of column names for this Recordset.  This is useful for determining  </span></span><br><span class="line"><span class="comment">	 * what you can actually ask the record set for without having to hard code those ahead of time.  </span></span><br><span class="line"><span class="comment">	 */</span>  </span><br><span class="line">	<span class="keyword">virtual</span> TArray&lt;FDatabaseColumnInfo&gt; GetColumnNames() <span class="keyword">const</span></span><br><span class="line">	&#123;  </span><br><span class="line">		<span class="keyword">return</span> Retval;  </span><br><span class="line">	&#125;   </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Constructor, used to associate ADO record set with this class.</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * @param InADORecordSet	ADO record set to use</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	FADODataBaseRecordSet( ADODB::_RecordsetPtr InADORecordSet )</span><br><span class="line">	:	ADORecordSet( InADORecordSet )</span><br><span class="line">	&#123;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/** Destructor, cleaning up ADO record set. */</span></span><br><span class="line">	<span class="keyword">virtual</span> ~FADODataBaseRecordSet()</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span>(ADORecordSet &amp;&amp; (ADORecordSet-&gt;State &amp; ADODB::adStateOpen))</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="comment">// We're using smart pointers so all we need to do is close and assign NULL.</span></span><br><span class="line">			ADORecordSet-&gt;Close();</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		ADORecordSet = <span class="literal">NULL</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<h4 id="2-2-3-FADODataBaseConnection"><a href="#2-2-3-FADODataBaseConnection" class="headerlink" title="2.2.3 FADODataBaseConnection"></a>2.2.3 FADODataBaseConnection</h4><p>&emsp;&emsp;<code>FADODataBaseConnection</code>派生自<code>FDataBaseConnection</code>，主要完成数据库的连接工作。<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Data base connection class using ADO C++ interface to communicate with SQL server.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FADODataBaseConnection</span> :</span> <span class="keyword">public</span> FDataBaseConnection</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">	<span class="comment">/** ADO database connection object. */</span></span><br><span class="line">	ADODB::_ConnectionPtr DataBaseConnection;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="comment">/** Constructor, initializing all member variables. */</span></span><br><span class="line">	FADODataBaseConnection()</span><br><span class="line">	&#123;</span><br><span class="line">		DataBaseConnection = <span class="literal">NULL</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/** Destructor, tearing down connection. */</span></span><br><span class="line">	<span class="keyword">virtual</span> ~FADODataBaseConnection()</span><br><span class="line">	&#123;</span><br><span class="line">		Close();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Opens a connection to the database.</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * @param	ConnectionString	Connection string passed to database layer</span></span><br><span class="line"><span class="comment">	 * @param   RemoteConnectionIP  The IP address which the RemoteConnection should connect to</span></span><br><span class="line"><span class="comment">	 * @param   RemoteConnectionStringOverride  The connection string which the RemoteConnection is going to utilize</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * @return	true if connection was successfully established, false otherwise</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">bool</span> <span class="title">Open</span><span class="params">( <span class="keyword">const</span> TCHAR* ConnectionString, <span class="keyword">const</span> TCHAR* RemoteConnectionIP, <span class="keyword">const</span> TCHAR* RemoteConnectionStringOverride )</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Closes connection to database.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">Close</span><span class="params">()</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Executes the passed in command on the database.</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * @param CommandString		Command to execute</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * @return true if execution was successful, false otherwise</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">bool</span> <span class="title">Execute</span><span class="params">( <span class="keyword">const</span> TCHAR* CommandString )</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Executes the passed in command on the database. The caller is responsible for deleting</span></span><br><span class="line"><span class="comment">	 * the created RecordSet.</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * @param CommandString		Command to execute</span></span><br><span class="line"><span class="comment">	 * @param RecordSet			Reference to recordset pointer that is going to hold result</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * @return true if execution was successful, false otherwise</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">bool</span> <span class="title">Execute</span><span class="params">( <span class="keyword">const</span> TCHAR* CommandString, FDataBaseRecordSet*&amp; RecordSet )</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		<span class="keyword">return</span> RecordSet != <span class="literal">NULL</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p>&emsp;&emsp;从以上的类的实现可以看出，UE4中数据库对ADO的封装主要是将数据库连接封装成了<code>FADODataBaseConnection</code>，记录集封装成了<code>FADODataBaseRecordSet</code>类，并且在这两个类的实现中，涉及的UE基本类型主要是<code>FString</code>和<code>TArray</code>，这两个类都可以通过使用普通C++类进行替代，因此，将代码从UE4中分离出来难度将不会太大。</p>
<h2 id="3、独立于UE4的封装"><a href="#3、独立于UE4的封装" class="headerlink" title="3、独立于UE4的封装"></a>3、独立于UE4的封装</h2><p>&emsp;&emsp;正如在第2节中所表明的，可以参考UE4 ADO操作数据库的方式对ADO进行封装，只要解决在无UE4代码的情况下替代FString和TARRY两个类即可。<br>&emsp;&emsp;在实际编译中发现在#import引入msado15.dll时，会报找不到文件的错误，我没有仔细去分析什么原因了，直接采用了绝对路径，等下次有时间再去找原因了。<br>&emsp;&emsp;我直接将其封装成了一个头文件，方便使用。<strong>注意</strong>，我是在MFC环境下封装的，所以头文件里会带上stdafx.h，需要使用的话请自己酌情修改。<br>&emsp;&emsp;代码比较长，在<strong>附录</strong>中。</p>
<h2 id="4、测试"><a href="#4、测试" class="headerlink" title="4、测试"></a>4、测试</h2><p>&emsp;&emsp;我尝试使用一个MFC工程，利用刚才封装的ADO操作数据库代码去连接并读取数据库里的内容。我使用的数据库是Access数据库，数据库表结构如下：<br><img src="/2018/10/28/UE4源代码分析/【UE4源代码分析】-007 仿UE4使用ADO进行数据库操作/【UE4源代码分析】-007 仿UE4使用ADO进行数据库操作/database.PNG"></p>
<div align="center">图3 数据库表结构</div>

<p>&emsp;&emsp;数据库中已有的记录集如所示。<br><img src="/2018/10/28/UE4源代码分析/【UE4源代码分析】-007 仿UE4使用ADO进行数据库操作/【UE4源代码分析】-007 仿UE4使用ADO进行数据库操作/records.PNG"></p>
<div align="center">图4 6条数据记录</div>

<p>&emsp;&emsp;在对话框窗口初始化的时候连接并读取数据库表中的记录，将记录总数和其中的username字段内容显示在界面上。<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">FDataBaseConnection* pConn = <span class="keyword">new</span> FADODataBaseConnection;</span><br><span class="line">	<span class="keyword">bool</span> hr = pConn-&gt;Open(<span class="string">L"Provider=Microsoft.Jet.OLEDB.4.0;Data Source=DatabaseFromUE4.mdb"</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>);</span><br><span class="line">	<span class="keyword">if</span> (hr)</span><br><span class="line">	&#123;</span><br><span class="line">		FDataBaseRecordSet* pRes = <span class="literal">NULL</span>;</span><br><span class="line">		pConn-&gt;Execute(<span class="string">L"SELECT * FROM usernameS"</span>, pRes);</span><br><span class="line">		<span class="keyword">if</span> (pRes)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">int</span> nCount = pRes-&gt;GetRecordCount();</span><br><span class="line">			CString strInfo;</span><br><span class="line">			strInfo.Format(<span class="string">L"表中有%d条记录,名字分别是："</span>, nCount);</span><br><span class="line">			FDataBaseRecordSet::<span class="function">TIterator <span class="title">itor</span><span class="params">(pRes)</span></span>;</span><br><span class="line">			<span class="keyword">while</span> (itor)</span><br><span class="line">			&#123;</span><br><span class="line">				CString temp = itor-&gt;GetString(<span class="string">L"username"</span>);</span><br><span class="line">				TRACE(<span class="string">L"%s\n"</span>, temp);</span><br><span class="line">				strInfo = strInfo + <span class="string">L" "</span> + temp;</span><br><span class="line">				++itor;</span><br><span class="line">			&#125;</span><br><span class="line">			GetDlgItem(IDC_INFO)-&gt;SetWindowText(strInfo);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">delete</span> pRes;</span><br><span class="line">		pRes = <span class="literal">NULL</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	pConn-&gt;Close();</span><br><span class="line">	<span class="keyword">delete</span> pConn;</span><br><span class="line">	pConn = <span class="literal">NULL</span>;</span><br></pre></td></tr></table></figure></p>
<p>&emsp;&emsp;程序运行界面如下所示。<br><img src="/2018/10/28/UE4源代码分析/【UE4源代码分析】-007 仿UE4使用ADO进行数据库操作/【UE4源代码分析】-007 仿UE4使用ADO进行数据库操作/run.PNG"></p>
<div align="center">图5 程序运行界面</div>

<p>&emsp;&emsp;从上图可以看出，通过封装的数据库操作，将数据库中的数据记录成功的读取出来了。</p>
<h2 id="5、总结"><a href="#5、总结" class="headerlink" title="5、总结"></a>5、总结</h2><p>&emsp;&emsp;参考UE4的数据库操作，对ADO操作数据库的过程进行了封装，能够完成数据库的查询，数据记录集的遍历，数据内容的获取。下次可以在项目中实际测试使用。<br>&emsp;&emsp;<strong>开发时多总结，闲暇时多阅读代码，总会有收获的。</strong></p>
<h2 id="6、附录"><a href="#6、附录" class="headerlink" title="6、附录"></a>6、附录</h2><p>&emsp;&emsp;项目源代码：<a href="https://github.com/freehawkzk/ADODBFromUE4.git" target="_blank" rel="noopener">https://github.com/freehawkzk/ADODBFromUE4.git</a><br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> once</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"stdafx.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;vector&gt;</span></span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* Enums for Database types.  Each Database has their own set of DB types and</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">enum</span> EDataBaseUnrealTypes</span><br><span class="line">&#123;</span><br><span class="line">	DBT_UNKOWN,</span><br><span class="line">	DBT_FLOAT,</span><br><span class="line">	DBT_INT,</span><br><span class="line">	DBT_STRING,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* This struct holds info relating to a column.  Specifically, we need to get back</span></span><br><span class="line"><span class="comment">* certain meta info from a RecordSet so we can "Get" data from it.</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">FDatabaseColumnInfo</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">	<span class="comment">/** Default constructor **/</span></span><br><span class="line">	FDatabaseColumnInfo() : DataType(DBT_UNKOWN) &#123;&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/** The name of the column **/</span></span><br><span class="line">	CString ColumnName;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/** This is the type of data in this column.  (e.g. so you can do GetFloat or GetInt on the column **/</span></span><br><span class="line">	EDataBaseUnrealTypes DataType;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="keyword">bool</span> <span class="keyword">operator</span>==(<span class="keyword">const</span> FDatabaseColumnInfo&amp; OtherFDatabaseColumnInfo) <span class="keyword">const</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span> (ColumnName == OtherFDatabaseColumnInfo.ColumnName) &amp;&amp; (DataType == OtherFDatabaseColumnInfo.DataType);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* Empty base class for iterating over database records returned via query. Used on platforms not supporting</span></span><br><span class="line"><span class="comment">* a direct database connection.</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FDataBaseRecordSet</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">	<span class="comment">// Protected functions used internally for iteration.</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line">	<span class="comment">/** Moves to the first record in the set. */</span></span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">MoveToFirst</span><span class="params">()</span></span></span><br><span class="line"><span class="function">	</span>&#123;&#125;</span><br><span class="line">	<span class="comment">/** Moves to the next record in the set. */</span></span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">MoveToNext</span><span class="params">()</span></span></span><br><span class="line"><span class="function">	</span>&#123;&#125;</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	* Returns whether we are at the end.</span></span><br><span class="line"><span class="comment">	*</span></span><br><span class="line"><span class="comment">	* @return true if at the end, false otherwise</span></span><br><span class="line"><span class="comment">	*/</span></span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">bool</span> <span class="title">IsAtEnd</span><span class="params">()</span> <span class="keyword">const</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	*   Returns a count of the number of records in the record set</span></span><br><span class="line"><span class="comment">	*/</span></span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">int</span> <span class="title">GetRecordCount</span><span class="params">()</span> <span class="keyword">const</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	* Returns a string associated with the passed in field/ column for the current row.</span></span><br><span class="line"><span class="comment">	*</span></span><br><span class="line"><span class="comment">	* @param	Column	Name of column to retrieve data for in current row</span></span><br><span class="line"><span class="comment">	*/</span></span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> CString <span class="title">GetString</span><span class="params">(<span class="keyword">const</span> TCHAR* Column)</span> <span class="keyword">const</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		<span class="keyword">return</span> TEXT(<span class="string">"No database connection compiled in."</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	* Returns an integer associated with the passed in field/ column for the current row.</span></span><br><span class="line"><span class="comment">	*</span></span><br><span class="line"><span class="comment">	* @param	Column	Name of column to retrieve data for in current row</span></span><br><span class="line"><span class="comment">	*/</span></span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">int</span> <span class="title">GetInt</span><span class="params">(<span class="keyword">const</span> TCHAR* Column)</span> <span class="keyword">const</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	* Returns a float associated with the passed in field/ column for the current row.</span></span><br><span class="line"><span class="comment">	*</span></span><br><span class="line"><span class="comment">	* @param	Column	Name of column to retrieve data for in current row</span></span><br><span class="line"><span class="comment">	*/</span></span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">float</span> <span class="title">GetFloat</span><span class="params">(<span class="keyword">const</span> TCHAR* Column)</span> <span class="keyword">const</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	* Returns a int64 associated with the passed in field/ column for the current row.</span></span><br><span class="line"><span class="comment">	*</span></span><br><span class="line"><span class="comment">	* @param	Column	Name of column to retrieve data for in current row</span></span><br><span class="line"><span class="comment">	*/</span></span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> LONG64 <span class="title">GetBigInt</span><span class="params">(<span class="keyword">const</span> TCHAR* Column)</span> <span class="keyword">const</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	* Returns the set of column names for this Recordset.  This is useful for determining</span></span><br><span class="line"><span class="comment">	* what you can actually ask the record set for without having to hard code those ahead of time.</span></span><br><span class="line"><span class="comment">	*/</span></span><br><span class="line">	<span class="keyword">virtual</span> <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;FDatabaseColumnInfo&gt; GetColumnNames() <span class="keyword">const</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">std</span>::<span class="built_in">vector</span>&lt;FDatabaseColumnInfo&gt; Retval;</span><br><span class="line">		<span class="keyword">return</span> Retval;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/** Virtual destructor as class has virtual functions. */</span></span><br><span class="line">	<span class="keyword">virtual</span> ~FDataBaseRecordSet()</span><br><span class="line">	&#123;&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	* Iterator helper class based on FObjectIterator.</span></span><br><span class="line"><span class="comment">	*/</span></span><br><span class="line">	<span class="class"><span class="keyword">class</span> <span class="title">TIterator</span></span></span><br><span class="line"><span class="class">	&#123;</span></span><br><span class="line">	<span class="keyword">public</span>:</span><br><span class="line">		<span class="comment">/**</span></span><br><span class="line"><span class="comment">		* Initialization constructor.</span></span><br><span class="line"><span class="comment">		*</span></span><br><span class="line"><span class="comment">		* @param	InRecordSet		RecordSet to iterate over</span></span><br><span class="line"><span class="comment">		*/</span></span><br><span class="line">		TIterator(FDataBaseRecordSet* InRecordSet)</span><br><span class="line">			: RecordSet(InRecordSet)</span><br><span class="line">		&#123;</span><br><span class="line">			RecordSet-&gt;MoveToFirst();</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">/**</span></span><br><span class="line"><span class="comment">		* operator++ used to iterate to next element.</span></span><br><span class="line"><span class="comment">		*/</span></span><br><span class="line">		<span class="keyword">void</span> <span class="keyword">operator</span>++()</span><br><span class="line">		&#123;</span><br><span class="line">			RecordSet-&gt;MoveToNext();</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">/** Conversion to "bool" returning true if the iterator is valid. */</span></span><br><span class="line">		<span class="function">FORCEINLINE <span class="keyword">explicit</span> <span class="keyword">operator</span> <span class="title">bool</span><span class="params">()</span> <span class="keyword">const</span></span></span><br><span class="line"><span class="function">		</span>&#123;</span><br><span class="line">			<span class="keyword">return</span> !RecordSet-&gt;IsAtEnd();</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">/** inverse of the "bool" operator */</span></span><br><span class="line">		FORCEINLINE <span class="keyword">bool</span> <span class="keyword">operator</span> !() <span class="keyword">const</span></span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">return</span> !(<span class="keyword">bool</span>)*<span class="keyword">this</span>;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Access operators</span></span><br><span class="line">		FORCEINLINE FDataBaseRecordSet* <span class="keyword">operator</span>*() <span class="keyword">const</span></span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">return</span> RecordSet;</span><br><span class="line">		&#125;</span><br><span class="line">		FORCEINLINE FDataBaseRecordSet* <span class="keyword">operator</span>-&gt;() <span class="keyword">const</span></span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">return</span> RecordSet;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">protected</span>:</span><br><span class="line">		<span class="comment">/** Database record set being iterated over. */</span></span><br><span class="line">		FDataBaseRecordSet* RecordSet;</span><br><span class="line">	&#125;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* Empty base class for database access via executing SQL commands. Used on platforms not supporting</span></span><br><span class="line"><span class="comment">* a direct database connection.</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FDataBaseConnection</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="comment">/** Virtual destructor as we have virtual functions. */</span></span><br><span class="line">	<span class="keyword">virtual</span> ~FDataBaseConnection()</span><br><span class="line">	&#123;&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	* Opens a connection to the database.</span></span><br><span class="line"><span class="comment">	*</span></span><br><span class="line"><span class="comment">	* @param	ConnectionString	Connection string passed to database layer</span></span><br><span class="line"><span class="comment">	* @param   RemoteConnectionIP  The IP address which the RemoteConnection should connect to</span></span><br><span class="line"><span class="comment">	* @param   RemoteConnectionStringOverride  The connection string which the RemoteConnection is going to utilize</span></span><br><span class="line"><span class="comment">	*</span></span><br><span class="line"><span class="comment">	* @return	true if connection was successfully established, false otherwise</span></span><br><span class="line"><span class="comment">	*/</span></span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">bool</span> <span class="title">Open</span><span class="params">(<span class="keyword">const</span> TCHAR* ConnectionString, <span class="keyword">const</span> TCHAR* RemoteConnectionIP, <span class="keyword">const</span> TCHAR* RemoteConnectionStringOverride)</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	* Closes connection to database.</span></span><br><span class="line"><span class="comment">	*/</span></span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">Close</span><span class="params">()</span></span></span><br><span class="line"><span class="function">	</span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	* Executes the passed in command on the database.</span></span><br><span class="line"><span class="comment">	*</span></span><br><span class="line"><span class="comment">	* @param CommandString		Command to execute</span></span><br><span class="line"><span class="comment">	*</span></span><br><span class="line"><span class="comment">	* @return true if execution was successful, false otherwise</span></span><br><span class="line"><span class="comment">	*/</span></span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">bool</span> <span class="title">Execute</span><span class="params">(<span class="keyword">const</span> TCHAR* CommandString)</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	* Executes the passed in command on the database. The caller is responsible for deleting</span></span><br><span class="line"><span class="comment">	* the created RecordSet.</span></span><br><span class="line"><span class="comment">	*</span></span><br><span class="line"><span class="comment">	* @param CommandString		Command to execute</span></span><br><span class="line"><span class="comment">	* @param RecordSet			Reference to recordset pointer that is going to hold result</span></span><br><span class="line"><span class="comment">	*</span></span><br><span class="line"><span class="comment">	* @return true if execution was successful, false otherwise</span></span><br><span class="line"><span class="comment">	*/</span></span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">bool</span> <span class="title">Execute</span><span class="params">(<span class="keyword">const</span> TCHAR* CommandString, FDataBaseRecordSet*&amp; RecordSet)</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		RecordSet = <span class="literal">nullptr</span>;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	* Static function creating appropriate database connection object.</span></span><br><span class="line"><span class="comment">	*</span></span><br><span class="line"><span class="comment">	* @return	instance of platform specific database connection object</span></span><br><span class="line"><span class="comment">	*/</span></span><br><span class="line">	<span class="function"><span class="keyword">static</span> FDataBaseConnection* <span class="title">CreateObject</span><span class="params">()</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> FDataBaseConnection();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Using import allows making use of smart pointers easily. Please post to the list if a workaround such as</span></span><br><span class="line"><span class="comment">// using %COMMONFILES% works to hide the localization issues and non default program file folders.</span></span><br><span class="line"><span class="comment">//#import "C:\Program files\Common Files\System\Ado\msado15.dll" rename("EOF", "ADOEOF")</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> <span class="meta-keyword">warning</span>(push)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> <span class="meta-keyword">warning</span>(disable: 4471) <span class="comment">// a forward declaration of an unscoped enumeration must have an underlying type (int assumed)</span></span></span><br><span class="line"><span class="meta">#import <span class="meta-string">"C:\Program files\Common Files\System\ADO\msado15.dll"</span> rename(<span class="meta-string">"EOF"</span>, <span class="meta-string">"ADOEOF"</span>) <span class="comment">//lint !e322</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> <span class="meta-keyword">warning</span>(pop)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*-----------------------------------------------------------------------------</span></span><br><span class="line"><span class="comment">FADODataBaseRecordSet implementation.</span></span><br><span class="line"><span class="comment">-----------------------------------------------------------------------------*/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* ADO implementation of database record set.</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FADODataBaseRecordSet</span> :</span> <span class="keyword">public</span> FDataBaseRecordSet</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">	ADODB::_RecordsetPtr ADORecordSet;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line">	<span class="comment">/** Moves to the first record in the set. */</span></span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">MoveToFirst</span><span class="params">()</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (!ADORecordSet-&gt;BOF || !ADORecordSet-&gt;ADOEOF)</span><br><span class="line">		&#123;</span><br><span class="line">			ADORecordSet-&gt;MoveFirst();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">/** Moves to the next record in the set. */</span></span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">MoveToNext</span><span class="params">()</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (!ADORecordSet-&gt;ADOEOF)</span><br><span class="line">		&#123;</span><br><span class="line">			ADORecordSet-&gt;MoveNext();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	* Returns whether we are at the end.</span></span><br><span class="line"><span class="comment">	*</span></span><br><span class="line"><span class="comment">	* @return true if at the end, false otherwise</span></span><br><span class="line"><span class="comment">	*/</span></span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">bool</span> <span class="title">IsAtEnd</span><span class="params">()</span> <span class="keyword">const</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		<span class="keyword">return</span> !!ADORecordSet-&gt;ADOEOF;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	*   Returns a count of the number of records in the record set</span></span><br><span class="line"><span class="comment">	*/</span></span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">int</span> <span class="title">GetRecordCount</span><span class="params">()</span> <span class="keyword">const</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		<span class="keyword">return</span> ADORecordSet-&gt;RecordCount;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	* Returns a string associated with the passed in field/ column for the current row.</span></span><br><span class="line"><span class="comment">	*</span></span><br><span class="line"><span class="comment">	* @param	Column	Name of column to retrieve data for in current row</span></span><br><span class="line"><span class="comment">	*/</span></span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> CString <span class="title">GetString</span><span class="params">(<span class="keyword">const</span> TCHAR* Column)</span> <span class="keyword">const</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		CString ReturnString;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Retrieve specified column field value for selected row.</span></span><br><span class="line">		<span class="keyword">_variant_t</span> Value = ADORecordSet-&gt;GetCollect(Column);</span><br><span class="line">		<span class="comment">// Check variant type for validity and cast to specified type. _variant_t has overloaded cast operators.</span></span><br><span class="line">		<span class="keyword">if</span> (Value.vt != VT_NULL)</span><br><span class="line">		&#123;</span><br><span class="line">			ReturnString = (TCHAR*)<span class="keyword">_bstr_t</span>(Value);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">// Unknown column.</span></span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">		&#123;</span><br><span class="line">			ReturnString = TEXT(<span class="string">"Unknown Column"</span>);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span> ReturnString;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	* Returns an integer associated with the passed in field/ column for the current row.</span></span><br><span class="line"><span class="comment">	*</span></span><br><span class="line"><span class="comment">	* @param	Column	Name of column to retrieve data for in current row</span></span><br><span class="line"><span class="comment">	*/</span></span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">int</span> <span class="title">GetInt</span><span class="params">(<span class="keyword">const</span> TCHAR* Column)</span> <span class="keyword">const</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		<span class="keyword">int</span> ReturnValue = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Retrieve specified column field value for selected row.</span></span><br><span class="line">		<span class="keyword">_variant_t</span> Value = ADORecordSet-&gt;GetCollect(Column);</span><br><span class="line">		<span class="comment">// Check variant type for validity and cast to specified type. _variant_t has overloaded cast operators.</span></span><br><span class="line">		<span class="keyword">if</span> (Value.vt != VT_NULL)</span><br><span class="line">		&#123;</span><br><span class="line">			ReturnValue = (<span class="keyword">int</span>)Value;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> ReturnValue;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	* Returns a float associated with the passed in field/ column for the current row.</span></span><br><span class="line"><span class="comment">	*</span></span><br><span class="line"><span class="comment">	* @param	Column	Name of column to retrieve data for in current row</span></span><br><span class="line"><span class="comment">	*/</span></span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">float</span> <span class="title">GetFloat</span><span class="params">(<span class="keyword">const</span> TCHAR* Column)</span> <span class="keyword">const</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		<span class="keyword">float</span> ReturnValue = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Retrieve specified column field value for selected row.</span></span><br><span class="line">		<span class="keyword">_variant_t</span> Value = ADORecordSet-&gt;GetCollect(Column);</span><br><span class="line">		<span class="comment">// Check variant type for validity and cast to specified type. _variant_t has overloaded cast operators.</span></span><br><span class="line">		<span class="keyword">if</span> (Value.vt != VT_NULL)</span><br><span class="line">		&#123;</span><br><span class="line">			ReturnValue = (<span class="keyword">float</span>)Value;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span> ReturnValue;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	* Returns an int64 associated with the passed in field/ column for the current row.</span></span><br><span class="line"><span class="comment">	*</span></span><br><span class="line"><span class="comment">	* @param	Column	Name of column to retrieve data for in current row</span></span><br><span class="line"><span class="comment">	*/</span></span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> LONG64 <span class="title">GetBigInt</span><span class="params">(<span class="keyword">const</span> TCHAR* Column)</span> <span class="keyword">const</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		LONG64 ReturnValue = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Retrieve specified column field value for selected row.</span></span><br><span class="line">		<span class="keyword">_variant_t</span> Value = ADORecordSet-&gt;GetCollect(Column);</span><br><span class="line">		<span class="comment">// Check variant type for validity and cast to specified type. _variant_t has overloaded cast operators.</span></span><br><span class="line">		<span class="keyword">if</span> (Value.vt != VT_NULL)</span><br><span class="line">		&#123;</span><br><span class="line">			ReturnValue = (LONG64)Value;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span> ReturnValue;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	* Returns the set of column names for this Recordset.  This is useful for determining</span></span><br><span class="line"><span class="comment">	* what you can actually ask the record set for without having to hard code those ahead of time.</span></span><br><span class="line"><span class="comment">	*/</span></span><br><span class="line">	<span class="keyword">virtual</span> <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;FDatabaseColumnInfo&gt; GetColumnNames() <span class="keyword">const</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">std</span>::<span class="built_in">vector</span>&lt;FDatabaseColumnInfo&gt; Retval;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (!ADORecordSet-&gt;BOF || !ADORecordSet-&gt;ADOEOF)</span><br><span class="line">		&#123;</span><br><span class="line">			ADORecordSet-&gt;MoveFirst();</span><br><span class="line"></span><br><span class="line">			<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; ADORecordSet-&gt;Fields-&gt;Count; ++i)</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="keyword">_bstr_t</span> bstrName = ADORecordSet-&gt;Fields-&gt;Item[i]-&gt;Name;</span><br><span class="line">				<span class="keyword">_variant_t</span> varValue = ADORecordSet-&gt;Fields-&gt;Item[i]-&gt;Value;</span><br><span class="line">				ADODB::DataTypeEnum DataType = ADORecordSet-&gt;Fields-&gt;Item[i]-&gt;Type;</span><br><span class="line"></span><br><span class="line">				FDatabaseColumnInfo NewInfo;</span><br><span class="line">				NewInfo.ColumnName = CString((TCHAR*)<span class="keyword">_bstr_t</span>(bstrName));</span><br><span class="line"></span><br><span class="line">				<span class="comment">// from http://www.w3schools.com/ado/prop_field_type.asp#datatypeenum  </span></span><br><span class="line">				<span class="keyword">switch</span> (DataType)</span><br><span class="line">				&#123;</span><br><span class="line">				<span class="keyword">case</span> ADODB::adInteger:</span><br><span class="line">				<span class="keyword">case</span> ADODB::adBigInt:</span><br><span class="line">					NewInfo.DataType = DBT_INT;</span><br><span class="line">					<span class="keyword">break</span>;</span><br><span class="line">				<span class="keyword">case</span> ADODB::adSingle:</span><br><span class="line">				<span class="keyword">case</span> ADODB::adDouble:</span><br><span class="line">					NewInfo.DataType = DBT_FLOAT;</span><br><span class="line">					<span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">				<span class="keyword">case</span> ADODB::adWChar:</span><br><span class="line">				<span class="keyword">case</span> ADODB::adVarWChar:</span><br><span class="line">					NewInfo.DataType = DBT_STRING;</span><br><span class="line">					<span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">				<span class="keyword">default</span>:</span><br><span class="line">					NewInfo.DataType = DBT_UNKOWN;</span><br><span class="line">					<span class="keyword">break</span>;</span><br><span class="line">				&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">				Retval.push_back(NewInfo);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span> Retval;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	* Constructor, used to associate ADO record set with this class.</span></span><br><span class="line"><span class="comment">	*</span></span><br><span class="line"><span class="comment">	* @param InADORecordSet	ADO record set to use</span></span><br><span class="line"><span class="comment">	*/</span></span><br><span class="line">	FADODataBaseRecordSet(ADODB::_RecordsetPtr InADORecordSet)</span><br><span class="line">		: ADORecordSet(InADORecordSet)</span><br><span class="line">	&#123;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/** Destructor, cleaning up ADO record set. */</span></span><br><span class="line">	<span class="keyword">virtual</span> ~FADODataBaseRecordSet()</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span> (ADORecordSet &amp;&amp; (ADORecordSet-&gt;State &amp; ADODB::adStateOpen))</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="comment">// We're using smart pointers so all we need to do is close and assign NULL.</span></span><br><span class="line">			ADORecordSet-&gt;Close();</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		ADORecordSet = <span class="literal">NULL</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/*-----------------------------------------------------------------------------</span></span><br><span class="line"><span class="comment">FADODataBaseConnection implementation.</span></span><br><span class="line"><span class="comment">-----------------------------------------------------------------------------*/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* Data base connection class using ADO C++ interface to communicate with SQL server.</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FADODataBaseConnection</span> :</span> <span class="keyword">public</span> FDataBaseConnection</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">	<span class="comment">/** ADO database connection object. */</span></span><br><span class="line">	ADODB::_ConnectionPtr DataBaseConnection;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="comment">/** Constructor, initializing all member variables. */</span></span><br><span class="line">	FADODataBaseConnection()</span><br><span class="line">	&#123;</span><br><span class="line">		DataBaseConnection = <span class="literal">NULL</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/** Destructor, tearing down connection. */</span></span><br><span class="line">	<span class="keyword">virtual</span> ~FADODataBaseConnection()</span><br><span class="line">	&#123;</span><br><span class="line">		Close();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	* Opens a connection to the database.</span></span><br><span class="line"><span class="comment">	*</span></span><br><span class="line"><span class="comment">	* @param	ConnectionString	Connection string passed to database layer</span></span><br><span class="line"><span class="comment">	* @param   RemoteConnectionIP  The IP address which the RemoteConnection should connect to</span></span><br><span class="line"><span class="comment">	* @param   RemoteConnectionStringOverride  The connection string which the RemoteConnection is going to utilize</span></span><br><span class="line"><span class="comment">	*</span></span><br><span class="line"><span class="comment">	* @return	true if connection was successfully established, false otherwise</span></span><br><span class="line"><span class="comment">	*/</span></span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">bool</span> <span class="title">Open</span><span class="params">(<span class="keyword">const</span> TCHAR* ConnectionString, <span class="keyword">const</span> TCHAR* RemoteConnectionIP, <span class="keyword">const</span> TCHAR* RemoteConnectionStringOverride)</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (!::AfxOleInit())</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Create instance of DB connection object.</span></span><br><span class="line">		HRESULT hr = DataBaseConnection.CreateInstance(__uuidof(ADODB::Connection));</span><br><span class="line">		<span class="keyword">if</span> (FAILED(hr))</span><br><span class="line">		&#123;</span><br><span class="line">			::CoUninitialize();</span><br><span class="line">			<span class="keyword">throw</span> _com_error(hr);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Open the connection. Operation is synchronous.</span></span><br><span class="line">		DataBaseConnection-&gt;Open(ConnectionString, TEXT(<span class="string">""</span>), TEXT(<span class="string">""</span>), ADODB::adConnectUnspecified);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	* Closes connection to database.</span></span><br><span class="line"><span class="comment">	*/</span></span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">Close</span><span class="params">()</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		<span class="comment">// Close database connection if exists and free smart pointer.</span></span><br><span class="line">		<span class="keyword">if</span> (DataBaseConnection &amp;&amp; (DataBaseConnection-&gt;State &amp; ADODB::adStateOpen))</span><br><span class="line">		&#123;</span><br><span class="line">			DataBaseConnection-&gt;Close();</span><br><span class="line"></span><br><span class="line">			::CoUninitialize();</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		DataBaseConnection = <span class="literal">NULL</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	* Executes the passed in command on the database.</span></span><br><span class="line"><span class="comment">	*</span></span><br><span class="line"><span class="comment">	* @param CommandString		Command to execute</span></span><br><span class="line"><span class="comment">	*</span></span><br><span class="line"><span class="comment">	* @return true if execution was successful, false otherwise</span></span><br><span class="line"><span class="comment">	*/</span></span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">bool</span> <span class="title">Execute</span><span class="params">(<span class="keyword">const</span> TCHAR* CommandString)</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		<span class="comment">// Execute command, passing in optimization to tell DB to not return records.</span></span><br><span class="line">		DataBaseConnection-&gt;Execute(CommandString, <span class="literal">NULL</span>, ADODB::adExecuteNoRecords);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	* Executes the passed in command on the database. The caller is responsible for deleting</span></span><br><span class="line"><span class="comment">	* the created RecordSet.</span></span><br><span class="line"><span class="comment">	*</span></span><br><span class="line"><span class="comment">	* @param CommandString		Command to execute</span></span><br><span class="line"><span class="comment">	* @param RecordSet			Reference to recordset pointer that is going to hold result</span></span><br><span class="line"><span class="comment">	*</span></span><br><span class="line"><span class="comment">	* @return true if execution was successful, false otherwise</span></span><br><span class="line"><span class="comment">	*/</span></span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">bool</span> <span class="title">Execute</span><span class="params">(<span class="keyword">const</span> TCHAR* CommandString, FDataBaseRecordSet*&amp; RecordSet)</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		<span class="comment">// Initialize return value.</span></span><br><span class="line">		RecordSet = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Create instance of record set.</span></span><br><span class="line">		ADODB::_RecordsetPtr ADORecordSet = <span class="literal">NULL</span>;</span><br><span class="line">		ADORecordSet.CreateInstance(__uuidof(ADODB::Recordset));</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Execute the passed in command on the record set. The recordset returned will be in open state so you can call Get* on it directly.</span></span><br><span class="line">		ADORecordSet-&gt;Open(CommandString, <span class="keyword">_variant_t</span>((IDispatch *)DataBaseConnection), ADODB::adOpenStatic, ADODB::adLockReadOnly, ADODB::adCmdText);</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Create record set from returned data.</span></span><br><span class="line">		RecordSet = <span class="keyword">new</span> FADODataBaseRecordSet(ADORecordSet);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span> RecordSet != <span class="literal">NULL</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2018/10/28/UE4源代码分析/【UE4源代码分析】-007 仿UE4使用ADO进行数据库操作/【UE4源代码分析】-007 仿UE4使用ADO进行数据库操作/" data-id="cjnroz8p9000c6l9s6ec6y08k" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-UE4源代码分析/【UE4源代码分析】-009 寻找UE4的D3D设备/【UE4源代码分析】-009 寻找UE4的D3D设备" class="article article-type-post" itemscope="" itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/10/28/UE4源代码分析/【UE4源代码分析】-009 寻找UE4的D3D设备/【UE4源代码分析】-009 寻找UE4的D3D设备/" class="article-date">
  <time datetime="2018-10-27T16:34:35.000Z" itemprop="datePublished">2018-10-28</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/10/28/UE4源代码分析/【UE4源代码分析】-009 寻找UE4的D3D设备/【UE4源代码分析】-009 寻找UE4的D3D设备/">【UE4源代码分析】-009 寻找UE4的D3D设备</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>&emsp;&emsp;UE4作为一款3D游戏引擎，当然也离不开显卡的支持。目前，主流的3D API主要包括DirectX、OpenGL、Vankul三种。其中，OpenGL和Vankul是支持跨平台的，而DirectX只能在windows平台上使用。UE4在windows平台上可以选择使用DX12或DX11等directX设备作为渲染设备。而D3D设备在使用之前是必须先创建的。<br>&emsp;&emsp;那么，今天让我们一起来探寻windows下使用DirectX作为渲染API时是在什么时候创建的D3D设备。</p>
<p>[TOC]</p>
<h2 id="1-创建过程"><a href="#1-创建过程" class="headerlink" title="1 创建过程"></a>1 创建过程</h2><p>&emsp;&emsp;在上一篇中，我们知道UE4启动之后经过了PreInit,init,tick,exit四个过程。那么，我们首先从PreInit开始寻找。<br>&emsp;&emsp;<code>EnginePreInit</code>函数实现在<code>Engine\Source\Runtime\Launch\Private</code>中进行实现，实现过程只是调用在<code>Engine\Source\Runtime\Launch\Private\LaunchEngineLoop.cpp</code>中实现的<code>FEngineLoop::PreInit</code>函数，由此可见，重点在<code>FEngineLoop::PreInit</code>函数。<br>&emsp;&emsp;我们查看<code>FEngineLoop::PreInit</code>的源代码，发现该函数是一个很长的函数，从934行一直到2401行，总行数1468行。在这个长长的函数中，我们需要寻找我们关心的内容。<br>&emsp;&emsp;在1780行，调用了<code>RHIInit</code>函数。这里，出现了RHI这个名词。RHI是Render Hardware Interface(渲染硬件接口)的意思。由于UE4的跨平台的需求，不同平台上需要使用不同的3D API来进行渲染。为了对上层程序员隐藏底层渲染的实现，UE4提出了RHI的概念，将底层渲染相关工作全部通过RHI来进行抽象，使上层程序员不用关系底层到底是用的是什么3D API，只需要关心实现的效果即可。<br>&emsp;&emsp;在<code>RHIInit</code>中，判断了<code>GDynamicRHI</code>指针的有效性，从变量命名来看，这是一个全部的DynamicRHI指针，极有可能是指向渲染设备的。因此，本指针内容的创建极有可能包含3D设备的创建过程。函数中进行了如下调用<code>GDynamicRHI = PlatformCreateDynamicRHI();</code>,可见，这是在创建GDynamicRHI的内容，咱们需要继续深入。<br>&emsp;&emsp;在<code>PlatformCreateDynamicRHI</code>中，经过一系列对平台所支持的API的判断以及本程序所选择的API的判断之后，最终来到了以下调用：<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (DynamicRHIModule)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">// Create the dynamic RHI.</span></span><br><span class="line">	DynamicRHI = DynamicRHIModule-&gt;CreateRHI(RequestedFeatureLevel);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> DynamicRHI;</span><br></pre></td></tr></table></figure></p>
<p>&emsp;&emsp;创建了一个DynamicRHI对象并将指针返回给了GDynamicRHI指针。可见，我们需要重点关注CreateRHI接口。此时，<code>DynamicRHIModule</code>是一个windows D3D11 的RHI Module。因此，我们可以继续向下。<br>&emsp;&emsp;在<code>Engine\Source\Runtime\Windows\D3D11RHI\Private\Windows\WindowsD3D11Device.cpp</code>中，定义了该module的CreateRHI接口。<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">TRefCountPtr&lt;IDXGIFactory1&gt; DXGIFactory1;</span><br><span class="line">	SafeCreateDXGIFactory(DXGIFactory1.GetInitReference());</span><br><span class="line">	check(DXGIFactory1);</span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">new</span> FD3D11DynamicRHI(DXGIFactory1,ChosenAdapter.MaxSupportedFeatureLevel,ChosenAdapter.AdapterIndex,ChosenDescription);</span><br></pre></td></tr></table></figure></p>
<p>&emsp;&emsp;这里貌似就要达到目标了，可当我们进入<code>FD3D11DynamicRHI</code>的构造函数的时候，在里面却并没有发现熟悉的创建D3D11设备的过程。但，在<code>FD3D11DynamicRHI</code>类中，我们发现了一下两个成员函数<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** If it hasn't been initialized yet, initializes the D3D device. */</span></span><br><span class="line"><span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">InitD3DDevice</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// FDynamicRHI interface.</span></span><br><span class="line"><span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">Init</span><span class="params">()</span> override</span>;</span><br></pre></td></tr></table></figure></p>
<p>其中<code>Init</code>函数内部调用了<code>InitD3DDevice</code>函数。<code>InitD3DDevice</code>的实现如下：<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> FD3D11DynamicRHI::InitD3DDevice()</span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">// If we don't have a device yet, either because this is the first viewport, or the old device was removed, create a device.</span></span><br><span class="line">	<span class="keyword">if</span>(!Direct3DDevice)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">// Determine the adapter and device type to use.</span></span><br><span class="line">		TRefCountPtr&lt;IDXGIAdapter&gt; Adapter;</span><br><span class="line">		</span><br><span class="line">		<span class="comment">// In Direct3D 11, if you are trying to create a hardware or a software device, set pAdapter != NULL which constrains the other inputs to be:</span></span><br><span class="line">		<span class="comment">//		DriverType must be D3D_DRIVER_TYPE_UNKNOWN </span></span><br><span class="line">		<span class="comment">//		Software must be NULL. </span></span><br><span class="line">		D3D_DRIVER_TYPE DriverType = D3D_DRIVER_TYPE_UNKNOWN;	</span><br><span class="line"></span><br><span class="line">		uint32 DeviceFlags = D3D11RHI_ShouldAllowAsyncResourceCreation() ? <span class="number">0</span> : D3D11_CREATE_DEVICE_SINGLETHREADED;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Use a debug device if specified on the command line.</span></span><br><span class="line">		<span class="keyword">const</span> <span class="keyword">bool</span> bWithD3DDebug = D3D11RHI_ShouldCreateWithD3DDebug();</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (bWithD3DDebug)</span><br><span class="line">		&#123;</span><br><span class="line">			DeviceFlags |= D3D11_CREATE_DEVICE_DEBUG;</span><br><span class="line"></span><br><span class="line">			UE_LOG(LogD3D11RHI, Log, TEXT(<span class="string">"InitD3DDevice: -D3DDebug = %s"</span>), bWithD3DDebug ? TEXT(<span class="string">"on"</span>) : TEXT(<span class="string">"off"</span>));</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		GTexturePoolSize = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">		TRefCountPtr&lt;IDXGIAdapter&gt; EnumAdapter;</span><br><span class="line">        <span class="comment">//枚举显卡设备</span></span><br><span class="line">		<span class="keyword">if</span>(DXGIFactory1-&gt;EnumAdapters(ChosenAdapter,EnumAdapter.GetInitReference()) != DXGI_ERROR_NOT_FOUND)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">if</span> (EnumAdapter)</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="comment">// 枚举成功</span></span><br><span class="line">				</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">		&#123;</span><br><span class="line">			check(!<span class="string">"Internal error, EnumAdapters() failed but before it worked"</span>)</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">//创建D3D11设备</span></span><br><span class="line">		<span class="keyword">if</span> (!bDeviceCreated)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="comment">// Creating the Direct3D device.</span></span><br><span class="line">			VERIFYD3D11RESULT(D3D11CreateDevice(</span><br><span class="line">				Adapter,</span><br><span class="line">				DriverType,</span><br><span class="line">				<span class="literal">NULL</span>,</span><br><span class="line">				DeviceFlags,</span><br><span class="line">				&amp;FeatureLevel,</span><br><span class="line">				<span class="number">1</span>,</span><br><span class="line">				D3D11_SDK_VERSION,</span><br><span class="line">				Direct3DDevice.GetInitReference(),</span><br><span class="line">				&amp;ActualFeatureLevel,</span><br><span class="line">				Direct3DDeviceIMContext.GetInitReference()</span><br><span class="line">			));</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Set the RHI initialized flag.</span></span><br><span class="line">		GIsRHIInitialized = <span class="literal">true</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>从中可以看出，UE4中D3D11设备的创建时在<code>InitD3DDevice</code>函数中进行的，那是在什么时候调用的这个函数呢？<br>前面我们已经发现Init函数会调用它，那么<code>FD3D11DynamicRHI::Init</code>是在什么时候被调用呢？<br>&emsp;&emsp;我们回到<code>RHIInit</code>函数中，<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">GDynamicRHI = PlatformCreateDynamicRHI();</span><br><span class="line"><span class="keyword">if</span> (GDynamicRHI)</span><br><span class="line">&#123;</span><br><span class="line">	GDynamicRHI-&gt;Init();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>发现通过<code>PlatformCreateDynamicRHI</code>函数创建了<code>FD3D11DynamicRHI</code>对象之后会紧接着就进行该RHI对象的Init操作，从而调用<code>InitD3DDevice</code>函数完成第一个D3D11设备的创建。<br>&emsp;&emsp;至此，D3D11设备就被创建出来并用于相关资源的初始化工作，待渲染进行开始之后就可以用于渲染。</p>
<h2 id="2-RHI"><a href="#2-RHI" class="headerlink" title="2 RHI"></a>2 RHI</h2><p>&emsp;&emsp;RHI: Render hardware interface 渲染硬件层接口， 本人理解RHI是一套硬件无关，平台无关的图形渲染API.<br>&emsp;&emsp;它是如何做到与平台无关，与硬件无关的呢？<br>&emsp;&emsp;每个RHI接口都对应着多个图形API的实现版本. 对于每个RHI接口，其实都有针对DX11，DX12，OpenGL等版本的实现。对于不同平台，引擎初始化的时候就已经确定要用哪一套图形API了。 之后，调用的RHI其实就是对应初始化时候确定用的那套图形API实现的版本.<br>&emsp;&emsp;比如RHIDrawIndexedPrimitive接口，对于DX,OPENGL，其实都实现了RHIDrawIndexedPrimitive接口。<br>&emsp;&emsp;当引擎初始化的时候，判断是在windows平台上的，并决定使用DX11。之后，当调用RHIDrawIndexedPrimitive接口时，其实调用的是DX11版本的RHIDrawIndexedPrimitive。<br>&emsp;&emsp;对于RHI使用者而已，不需要关心是调用了哪套图形API，反正能正确运行，从而造成跨平台的假象；而从开发角度而言，RHI并不是平台无关的，它需要开发人员呕心沥血地开发和维护，以保证RHI在不同平台下运行结果都一样。<br>&emsp;&emsp;DynamicRHI.h里 FDynamicRHI， IRHIComputeContext两个虚基类里定义了所有的RHI接口。<br>实现RHI接口的子类有：</p>
<ol>
<li>class D3D11RHI_API FD3D11DynamicRHI : public FDynamicRHI, public IRHICommandContext</li>
<li>class FD3D12DynamicRHI : public FDynamicRHI</li>
<li>class OPENGLDRV_API FOpenGLDynamicRHI : public FDynamicRHI, public IRHICommandContext<br>Vulkan： 新一代跨平台，充分利用多核多线程的图形API</li>
<li>class FVulkanDynamicRHI : public FDynamicRHI<br>Metal：苹果系统的图形API             </li>
<li>class FMetalDynamicRHI : public FDynamicRHI, public FMetalRHICommandContext<h2 id="3-结论"><a href="#3-结论" class="headerlink" title="3 结论"></a>3 结论</h2>&emsp;&emsp;<strong>UE4在执行<code>FEngineLoop::PreInit</code>时，完成D3D设备的创建工作。</strong></li>
</ol>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2018/10/28/UE4源代码分析/【UE4源代码分析】-009 寻找UE4的D3D设备/【UE4源代码分析】-009 寻找UE4的D3D设备/" data-id="cjnroz8p8000b6l9sdxbwmuno" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-UE4源代码分析/【UE4源代码分析】-008 从GuardedMain函数开始/【UE4源代码分析】-008 从GuardedMain函数开始" class="article article-type-post" itemscope="" itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/10/28/UE4源代码分析/【UE4源代码分析】-008 从GuardedMain函数开始/【UE4源代码分析】-008 从GuardedMain函数开始/" class="article-date">
  <time datetime="2018-10-27T16:34:35.000Z" itemprop="datePublished">2018-10-28</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/10/28/UE4源代码分析/【UE4源代码分析】-008 从GuardedMain函数开始/【UE4源代码分析】-008 从GuardedMain函数开始/">【UE4源代码分析】-008 从GuardedMain函数开始游戏循环</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>&emsp;&emsp;在上一篇《【UE4源代码分析】-005 Editor的起点-Main函数》(<a href="https://blog.csdn.net/freehawkzk/article/details/80593687)中，我们知道UE4程序启动运行时是从WinMain函数开始，之后调用`GuardedMain`函数进行处理，待`GuardedMain`退出之后，执行appExit之后程序退出。由此可见，整个游戏的有效处理实际上是发生在`GuardedMain`函数中的。今天，我们来看看在这个函数中间发生了什么。" target="_blank" rel="noopener">https://blog.csdn.net/freehawkzk/article/details/80593687)中，我们知道UE4程序启动运行时是从WinMain函数开始，之后调用`GuardedMain`函数进行处理，待`GuardedMain`退出之后，执行appExit之后程序退出。由此可见，整个游戏的有效处理实际上是发生在`GuardedMain`函数中的。今天，我们来看看在这个函数中间发生了什么。</a></p>
<p>[TOC]</p>
<h2 id="1、处理流程"><a href="#1、处理流程" class="headerlink" title="1、处理流程"></a>1、处理流程</h2><p>&emsp;&emsp;<code>GuardedMain</code>的代码流程是很清晰的，加上Epic的注释，很容易理解整体框架。<br>&emsp;&emsp;首先，由于UE4对windows的头文件进行了大量精简，在进入GuardedMain时还有一些运行环境初始化的工作没做，因此，先调用<code>FCoreDelegates::GetPreMainInitDelegate().Broadcast();</code>完成初始化工作。<br>&emsp;&emsp;然后，申明了一个内部类的局部变量，这里主要利用内部类局部变量析构的时候会自动执行析构函数，从而确保<code>EngineExit();</code>始终会得到执行。<br>&emsp;&emsp;接下来，主要工作是执行<code>int32 ErrorLevel = EnginePreInit( CmdLine );</code>,也就是进行引擎的预初始化工作。<br>&emsp;&emsp;之后，根据当前运行的程序是不是Editor，决定调用<code>EditorInit(GEngineLoop);</code>或<code>ErrorLevel = EngineInit();</code>,当本次运行的不是Editor的时候会执行EngineInit。经过代码跟踪，在EditorInit内部会调用EngineInit，也就是说Editor除了有游戏运行的相关资源要初始化之外还有很多其他的工作需要完成。<br>&emsp;&emsp;再接下来程序就进入游戏循环了。<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span>( !GIsRequestingExit )</span><br><span class="line">&#123;</span><br><span class="line">	EngineTick();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>&emsp;&emsp;当程序从游戏循环中退出的时候，如果是编辑器，需要执行EditorExit。再之后就是return退出函数了。<br>&emsp;&emsp;等等，按照对称原则，前面执行了EngineInit，后面应该有一个对应的Exit才对啊，难道不是Editor就不用Exit了么？原来，<code>EngineExit</code>在前面讲到的局部变量析构的时候会被自动调用，很对称。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">int32 <span class="title">GuardedMain</span><span class="params">( <span class="keyword">const</span> TCHAR* CmdLine, HINSTANCE hInInstance, HINSTANCE hPrevInstance, int32 nCmdShow )</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">// Super early init code. DO NOT MOVE THIS ANYWHERE ELSE!</span></span><br><span class="line">	FCoreDelegates::GetPreMainInitDelegate().Broadcast();</span><br><span class="line"></span><br><span class="line">	<span class="comment">// make sure GEngineLoop::Exit() is always called.</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">EngineLoopCleanupGuard</span> </span></span><br><span class="line"><span class="class">	&#123;</span> </span><br><span class="line">		~EngineLoopCleanupGuard()</span><br><span class="line">		&#123;</span><br><span class="line">			EngineExit();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125; CleanupGuard;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Set up minidump filename. We cannot do this directly inside main as we use an FString that requires </span></span><br><span class="line">	<span class="comment">// destruction and main uses SEH.</span></span><br><span class="line">	<span class="comment">// These names will be updated as soon as the Filemanager is set up so we can write to the log file.</span></span><br><span class="line">	<span class="comment">// That will also use the user folder for installed builds so we don't write into program files or whatever.</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> PLATFORM_WINDOWS</span></span><br><span class="line">	FCString::Strcpy(MiniDumpFilenameW, *FString::Printf(TEXT(<span class="string">"unreal-v%i-%s.dmp"</span>), FEngineVersion::Current().GetChangelist(), *FDateTime::Now().ToString()));</span><br><span class="line"></span><br><span class="line">	<span class="keyword">const</span> TCHAR* OrgCmdLine = CmdLine;</span><br><span class="line"></span><br><span class="line">	CmdLine = FCommandLine::RemoveExeName(OrgCmdLine);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">const</span> TCHAR* CmdOccurence = FCString::Stristr(OrgCmdLine, TEXT(<span class="string">"-cmd"</span>));</span><br><span class="line">	GIsConsoleExecutable = CmdOccurence != <span class="literal">NULL</span> &amp;&amp; CmdOccurence &lt; CmdLine;</span><br><span class="line">	</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">	int32 ErrorLevel = EnginePreInit( CmdLine );</span><br><span class="line"></span><br><span class="line">	<span class="comment">// exit if PreInit failed.</span></span><br><span class="line">	<span class="keyword">if</span> ( ErrorLevel != <span class="number">0</span> || GIsRequestingExit )</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span> ErrorLevel;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="function">FScopedSlowTask <span class="title">SlowTask</span><span class="params">(<span class="number">100</span>, NSLOCTEXT(<span class="string">"EngineInit"</span>, <span class="string">"EngineInit_Loading"</span>, <span class="string">"Loading..."</span>))</span></span>;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// EnginePreInit leaves 20% unused in its slow task.</span></span><br><span class="line">		<span class="comment">// Here we consume 80% immediately so that the percentage value on the splash screen doesn't change from one slow task to the next.</span></span><br><span class="line">		<span class="comment">// (Note, we can't include the call to EnginePreInit in this ScopedSlowTask, because the engine isn't fully initialized at that point)</span></span><br><span class="line">		SlowTask.EnterProgressFrame(<span class="number">80</span>);</span><br><span class="line"></span><br><span class="line">		SlowTask.EnterProgressFrame(<span class="number">20</span>);</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> WITH_EDITOR</span></span><br><span class="line">		<span class="keyword">if</span> (GIsEditor)</span><br><span class="line">		&#123;</span><br><span class="line">			ErrorLevel = EditorInit(GEngineLoop);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">#endif</span><br><span class="line">		&#123;</span><br><span class="line">			ErrorLevel = EngineInit();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">double</span> EngineInitializationTime = FPlatformTime::Seconds() - GStartTime;</span><br><span class="line">	UE_LOG(LogLoad, Log, TEXT(<span class="string">"(Engine Initialization) Total time: %.2f seconds"</span>), EngineInitializationTime);</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> WITH_EDITOR</span></span><br><span class="line">	UE_LOG(LogLoad, Log, TEXT(<span class="string">"(Engine Initialization) Total Blueprint compile time: %.2f seconds"</span>), BlueprintCompileAndLoadTimerData.GetTime());</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">	ACCUM_LOADTIME(TEXT(<span class="string">"EngineInitialization"</span>), EngineInitializationTime);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">while</span>( !GIsRequestingExit )</span><br><span class="line">	&#123;</span><br><span class="line">		EngineTick();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> WITH_EDITOR</span></span><br><span class="line">	<span class="keyword">if</span>( GIsEditor )</span><br><span class="line">	&#123;</span><br><span class="line">		EditorExit();</span><br><span class="line">	&#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	<span class="keyword">return</span> ErrorLevel;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="2、示意图"><a href="#2、示意图" class="headerlink" title="2、示意图"></a>2、示意图</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">st=&gt;start: 开始</span><br><span class="line">e=&gt;end: 结束</span><br><span class="line">RuntimeInit=&gt;operation: 初始化运行环境</span><br><span class="line">CreateInternalStruct=&gt;operation: 创建内部结构的局部变量</span><br><span class="line">EnginePreInit=&gt;operation: 引擎预初始化</span><br><span class="line">IsEditor=&gt;condition: 当前运行的是否是编辑器</span><br><span class="line">EditorInit=&gt;operation: 编辑器初始化</span><br><span class="line">EngineInit=&gt;operation: 引擎初始化</span><br><span class="line">EngineTick=&gt;condition: 游戏循环是否退出</span><br><span class="line">IsEditor2=&gt;condition: 当前运行的是否是编辑器</span><br><span class="line">EditorExit=&gt;operation: 退出编辑器</span><br><span class="line">Destruction=&gt;operation: 局部变量析构</span><br><span class="line">EngineExit=&gt;operation: 引擎退出</span><br><span class="line"></span><br><span class="line">st-&gt;RuntimeInit-&gt;CreateInternalStruct-&gt;EnginePreInit-&gt;IsEditor</span><br><span class="line">IsEditor(yes)-&gt;EditorInit-&gt;EngineTick</span><br><span class="line">IsEditor(no)-&gt;EngineInit-&gt;EngineTick</span><br><span class="line">EngineTick(yes)-&gt;IsEditor2</span><br><span class="line">IsEditor2(yes)-&gt;EditorExit-&gt;Destruction</span><br><span class="line">IsEditor2(no)-&gt;Destruction</span><br><span class="line">Destruction-&gt;EngineExit-&gt;e</span><br></pre></td></tr></table></figure>
      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2018/10/28/UE4源代码分析/【UE4源代码分析】-008 从GuardedMain函数开始/【UE4源代码分析】-008 从GuardedMain函数开始/" data-id="cjnroz8p7000a6l9s9tibrf0k" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-UE4源代码分析/【UE4源代码分析】-005 Editor的起点-Main函数/【UE4源代码分析】-005 Editor的起点-Main函数" class="article article-type-post" itemscope="" itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/10/28/UE4源代码分析/【UE4源代码分析】-005 Editor的起点-Main函数/【UE4源代码分析】-005 Editor的起点-Main函数/" class="article-date">
  <time datetime="2018-10-27T16:34:35.000Z" itemprop="datePublished">2018-10-28</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/10/28/UE4源代码分析/【UE4源代码分析】-005 Editor的起点-Main函数/【UE4源代码分析】-005 Editor的起点-Main函数/">【UE4源代码分析】-005 Editor的起点-Main函数</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="1、UE4-Editor的运行"><a href="#1、UE4-Editor的运行" class="headerlink" title="1、UE4-Editor的运行"></a>1、UE4-Editor的运行</h2><h3 id="1-1-UE4编辑器的位置"><a href="#1-1-UE4编辑器的位置" class="headerlink" title="1.1 UE4编辑器的位置"></a>1.1 UE4编辑器的位置</h3><p>&emsp;&emsp;<strong>UE4.sln</strong>编译完之后，在输出目录下会生成UE4Editor.exe,(图1所示)。</p>
<p><div align="center"><br><img src="/2018/10/28/UE4源代码分析/【UE4源代码分析】-005 Editor的起点-Main函数/【UE4源代码分析】-005 Editor的起点-Main函数/01-UE4Editor.PNG"><br></div></p>
<p><div align="center">图1 UE4Editor.exe</div><br></p>
<p>&emsp;&emsp;双击<strong>UE4Editor.exe</strong>即可启动经过我们自己编译的UE4编辑器。</p>
<h3 id="1-2-UE4编辑器启动过程"><a href="#1-2-UE4编辑器启动过程" class="headerlink" title="1.2 UE4编辑器启动过程"></a>1.2 UE4编辑器启动过程</h3><p>&emsp;&emsp;双击启动<strong>UE4Editor.exe</strong>之后，编辑器开始运行，首先会弹出程序启动画面，在该界面上显示编辑器启动过程以及进度。</p>
<p><div align="center"><br><img src="/2018/10/28/UE4源代码分析/【UE4源代码分析】-005 Editor的起点-Main函数/【UE4源代码分析】-005 Editor的起点-Main函数/02-UE4Editor-Splash Screen.PNG"><br></div></p>
<p><div align="center">图2 UE4Editor启动界面Splash Screen</div><br></p>
<p>&emsp;&emsp;启动界面上标明了当前启动的UE4引擎的版本-4.19.2，以及当前加载的进度。</p>
<p><div align="center"><br><img src="/2018/10/28/UE4源代码分析/【UE4源代码分析】-005 Editor的起点-Main函数/【UE4源代码分析】-005 Editor的起点-Main函数/03-UE4Editor-Splash Screen-01.PNG"><br></div></p>
<p><div align="center">图3 UE4Editor启动界面Splash Screen带加载进度</div><br></p>
<p>&emsp;&emsp;在完成了加载之后，程序进度已有工程选择界面，在该界面上，用户可以选择系统中已经存在的UE4项目进行编辑，<strong>注意</strong>：这里列出的项目包括计算机上历史版本的UE4引擎所创建的项目。</p>
<p><div align="center"><br><img src="/2018/10/28/UE4源代码分析/【UE4源代码分析】-005 Editor的起点-Main函数/【UE4源代码分析】-005 Editor的起点-Main函数/04-UE4Editor-Select Project-01.PNG"><br></div></p>
<p><div align="center">图4 UE4Editor选择项目</div><br></p>
<p>&emsp;&emsp;用户可以通过单击<strong>新建项目</strong>选项卡，进入新建项目界面。</p>
<p><div align="center"><br><img src="/2018/10/28/UE4源代码分析/【UE4源代码分析】-005 Editor的起点-Main函数/【UE4源代码分析】-005 Editor的起点-Main函数/05-UE4Editor-New Project-01.PNG"><br></div></p>
<p><div align="center">图5 UE4Editor新建项目</div><br></p>
<p>&emsp;&emsp;用户通过新建项目选项卡输入项目名称和存储位置之后，UE4会创建项目。可供创建的项目主要由两种类型——蓝图项目和C++项目。蓝图项目开发过程中，主要使用UE蓝图脚本进行开发，而C++项目主要使用C++语言在VS编辑器中进行开发。<br>&emsp;&emsp;这里，我选择创建C++空白项目。UE4编辑器完成项目文件的创建之后，自动使用VS2015打开了我刚才创建的C++空白项目(项目名称<strong>p1</strong>)。<br>&emsp;&emsp;项目文件目录结构如图所示。</p>
<p><div align="center"><br><img src="/2018/10/28/UE4源代码分析/【UE4源代码分析】-005 Editor的起点-Main函数/【UE4源代码分析】-005 Editor的起点-Main函数/06-UE4Editor-Project Files-01.PNG"><br></div></p>
<p><div align="center">图6 UE4Editor新建空白C++项目文件组织</div><br></p>
<p>&emsp;&emsp;从图6中可以看出，与UE4引擎源代码工程相比，p1项目多了一个Game项目，该项目为p1游戏的项目代码所在的位置。<br>&emsp;&emsp;至此，我们已经完成了用UE4编辑器创建UE4游戏的项目，可以在其中自由的编写项目代码，进行游戏开发了。<br>&emsp;&emsp;那么，<strong>UE4编辑器到底是怎么运行起来的呢？</strong></p>
<h2 id="2、函数调用起点"><a href="#2、函数调用起点" class="headerlink" title="2、函数调用起点"></a>2、函数调用起点</h2><p>&emsp;&emsp;UE4引擎是使用C++语言开发的，伟大的《C语言》、《C++》、《Windows程序设计》告诉我们，win32程序通常是从main函数或者WinMain函数开始执行的。(<em>排除全局变量构造等情况，只按常规套路出牌。</em>) 那么UE4Editor.exe是不是也是从这里开始执行的呢？<br>&emsp;&emsp;在Engine\Source\Runtime\Launch\Private\Windows\LaunchWindows.cpp中有WinMain函数。<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">int32 WINAPI <span class="title">WinMain</span><span class="params">( _In_ HINSTANCE hInInstance, _In_opt_ HINSTANCE hPrevInstance, _In_ <span class="keyword">char</span>*, _In_ int32 nCmdShow )</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">// Setup common Windows settings</span></span><br><span class="line">	SetupWindowsEnvironment();</span><br><span class="line"></span><br><span class="line">	int32 ErrorLevel			= <span class="number">0</span>;</span><br><span class="line">	hInstance				= hInInstance;</span><br><span class="line">	<span class="keyword">const</span> TCHAR* CmdLine = ::GetCommandLineW();</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> !(UE_BUILD_SHIPPING &amp;&amp; WITH_EDITOR)</span></span><br><span class="line">	<span class="comment">// Named mutex we use to figure out whether we are the first instance of the game running. This is needed to e.g.</span></span><br><span class="line">	<span class="comment">// make sure there is no contention when trying to save the shader cache.</span></span><br><span class="line">	GIsFirstInstance = MakeNamedMutex( CmdLine );</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> ( FParse::Param( CmdLine,TEXT(<span class="string">"crashreports"</span>) ) )</span><br><span class="line">	&#123;</span><br><span class="line">		GAlwaysReportCrash = <span class="literal">true</span>;</span><br><span class="line">	&#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// Using the -noinnerexception parameter will disable the exception handler within native C++, which is call from managed code,</span></span><br><span class="line">	<span class="comment">// which is called from this function.</span></span><br><span class="line">	<span class="comment">// The default case is to have three wrapped exception handlers </span></span><br><span class="line">	<span class="comment">// Native: WinMain() -&gt; Native: GuardedMainWrapper().</span></span><br><span class="line">	<span class="comment">// The inner exception handler in GuardedMainWrapper() catches crashes/asserts in native C++ code and is the only way to get the</span></span><br><span class="line">	<span class="comment">// correct callstack when running a 64-bit executable. However, XAudio2 sometimes (?) don't like this and it may result in no sound.</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> _WIN64</span></span><br><span class="line">	<span class="keyword">if</span> ( FParse::Param(CmdLine,TEXT(<span class="string">"noinnerexception"</span>)) || FApp::IsBenchmarking() )</span><br><span class="line">	&#123;</span><br><span class="line">		GEnableInnerException = <span class="literal">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span>	</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> WINVER &gt; 0x502	<span class="comment">// Windows Error Reporting is not supported on Windows XP</span></span></span><br><span class="line">	<span class="keyword">if</span> (FParse::Param(CmdLine, TEXT(<span class="string">"useautoreporter"</span>)))</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	&#123;</span><br><span class="line">		GUseCrashReportClient = <span class="literal">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> UE_BUILD_DEBUG</span></span><br><span class="line">	<span class="keyword">if</span>( <span class="literal">true</span> &amp;&amp; !GAlwaysReportCrash )</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">	<span class="keyword">if</span>( FPlatformMisc::IsDebuggerPresent() &amp;&amp; !GAlwaysReportCrash )</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">// Don't use exception handling when a debugger is attached to exactly trap the crash. This does NOT check</span></span><br><span class="line">		<span class="comment">// whether we are the first instance or not!</span></span><br><span class="line">		ErrorLevel = GuardedMain( CmdLine, hInInstance, hPrevInstance, nCmdShow );</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">// Install an unhandled exception filter, to catch any exceptions on threads that are not created by the engine.</span></span><br><span class="line">		SetUnhandledExceptionFilter(UnhandledException);</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Use structured exception handling to trap any crashes, walk the the stack and display a crash dialog box.</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> !PLATFORM_SEH_EXCEPTIONS_DISABLED</span></span><br><span class="line">		__try</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"> 		&#123;</span><br><span class="line">			GIsGuarded = <span class="number">1</span>;</span><br><span class="line">			<span class="comment">// Run the guarded code.</span></span><br><span class="line">			ErrorLevel = GuardedMainWrapper( CmdLine, hInInstance, hPrevInstance, nCmdShow );</span><br><span class="line">			GIsGuarded = <span class="number">0</span>;</span><br><span class="line">		&#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> !PLATFORM_SEH_EXCEPTIONS_DISABLED</span></span><br><span class="line">		__except( GEnableInnerException ? EXCEPTION_EXECUTE_HANDLER : ReportCrash( GetExceptionInformation( ) ) )</span><br><span class="line">		&#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> !(UE_BUILD_SHIPPING &amp;&amp; WITH_EDITOR)</span></span><br><span class="line">			<span class="comment">// Release the mutex in the error case to ensure subsequent runs don't find it.</span></span><br><span class="line">			ReleaseNamedMutex();</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">			<span class="comment">// Crashed.</span></span><br><span class="line">			ErrorLevel = <span class="number">1</span>;</span><br><span class="line">			<span class="keyword">if</span>(GError)</span><br><span class="line">			&#123;</span><br><span class="line">				GError-&gt;HandleError();</span><br><span class="line">			&#125;</span><br><span class="line">			LaunchStaticShutdownAfterError();</span><br><span class="line">			FPlatformMallocCrash::Get().PrintPoolsUsage();</span><br><span class="line">			FPlatformMisc::RequestExit( <span class="literal">true</span> );</span><br><span class="line">		&#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Final shut down.</span></span><br><span class="line">	FEngineLoop::AppExit();</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> !(UE_BUILD_SHIPPING &amp;&amp; WITH_EDITOR)</span></span><br><span class="line">	<span class="comment">// Release the named mutex again now that we are done.</span></span><br><span class="line">	ReleaseNamedMutex();</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">	</span><br><span class="line"></span><br><span class="line">	<span class="comment">// pause if we should</span></span><br><span class="line">	<span class="keyword">if</span> (GShouldPauseBeforeExit)</span><br><span class="line">	&#123;</span><br><span class="line">		Sleep(INFINITE);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> ErrorLevel;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>&emsp;&emsp;从以上的函数实现可以看出，对于UE4的WinMain函数，主要执行的工作是设置windows环境，创建命名Mutex，根据参数不同使用不同形式调用<code>GuardedMain</code>函数。在<code>GuardedMain</code>函数退出之后，结束引擎的循环，并释放命名Mutex，退出程序。<br>&emsp;&emsp;从上面可以看出，在WinMain函数中，主要工作是根据不同的参数，采用合适的形式调用GuardedMain函数，实际上对引擎的调用和其余工作都是在GuardedMain函数中完成的。</p>
<h2 id="3、思考"><a href="#3、思考" class="headerlink" title="3、思考"></a>3、思考</h2><p>&emsp;&emsp;由于UE4对windows的头文件进行了极大的裁剪，并且为了保持对出错之后生成dump文件或Crash报告的能力的支持，由于在<code>WinMain</code>函数中不具备这个能力，所以将大部分工作转移到<code>GuardedMain</code>函数中执行。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2018/10/28/UE4源代码分析/【UE4源代码分析】-005 Editor的起点-Main函数/【UE4源代码分析】-005 Editor的起点-Main函数/" data-id="cjnroz8p500096l9sedbneman" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-UE4源代码分析/【UE4源代码分析】-002 UE4中的配置文件/【UE4源代码分析】-002 UE4中的配置文件" class="article article-type-post" itemscope="" itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/10/28/UE4源代码分析/【UE4源代码分析】-002 UE4中的配置文件/【UE4源代码分析】-002 UE4中的配置文件/" class="article-date">
  <time datetime="2018-10-27T16:34:35.000Z" itemprop="datePublished">2018-10-28</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/10/28/UE4源代码分析/【UE4源代码分析】-002 UE4中的配置文件/【UE4源代码分析】-002 UE4中的配置文件/">【UE4源代码分析】-002 UE4中的配置文件</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="1、UE4配置文件类型"><a href="#1、UE4配置文件类型" class="headerlink" title="1、UE4配置文件类型"></a>1、UE4配置文件类型</h2><p>&emsp;UE4中，大量使用的配置文件类型并不是xml与json等新兴配置文件类型，而是使用相对古老的ini配置文件。<br>&emsp;在UE4的目录中，专门有Config目录用于存放使用的ini配置文件。</p>
<h2 id="2、配置文件的类型"><a href="#2、配置文件的类型" class="headerlink" title="2、配置文件的类型"></a>2、配置文件的类型</h2><p>&emsp;在Config目录下有很多各种各样的配置文件，各个配置文件基本上代表的是一类配置。通过查看\Engine\Source\Runtime\Core\Public\Misc\ConfigCacheIni.h文件，可以帮助我们判断各个配置文件的作用。<br>&emsp;在枚举类EConfigFileHierarchy中，对各个ini文件以及各个位置的ini配置文件的用途做了基本说明。<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">enum</span> <span class="class"><span class="keyword">class</span> <span class="title">EConfigFileHierarchy</span> :</span> uint8</span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">// Engine/Config/Base.ini</span></span><br><span class="line">	AbsoluteBase = <span class="number">0</span>,</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Engine/Config/*.ini</span></span><br><span class="line">	EngineDirBase,</span><br><span class="line">	<span class="comment">// Engine/Config/Platform/BasePlatform* ini</span></span><br><span class="line">	EngineDir_BasePlatform,</span><br><span class="line">	<span class="comment">// Engine/Config/NotForLicensees/*.ini</span></span><br><span class="line">	EngineDirBase_NotForLicensees,</span><br><span class="line">	<span class="comment">// Engine/Config/NoRedist/*.ini -Not supported at this time.</span></span><br><span class="line">	EngineDirBase_NoRedist,</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Game/Config/*.ini</span></span><br><span class="line">	GameDirDefault,</span><br><span class="line">	<span class="comment">// Game/Config/DedicatedServer*.ini</span></span><br><span class="line">	GameDirDedicatedServer,</span><br><span class="line">	<span class="comment">// Game/Config/NotForLicensees/*.ini</span></span><br><span class="line">	GameDirDefault_NotForLicensees,</span><br><span class="line">	<span class="comment">// Game/Config/NoRedist*.ini</span></span><br><span class="line">	GameDirDefault_NoRedist,</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Engine/Config/PlatformName/PlatformName*.ini</span></span><br><span class="line">	EngineDir_Platform,</span><br><span class="line">	<span class="comment">// Engine/Config/NotForLicensees/PlatformName/PlatformName*.ini</span></span><br><span class="line">	EngineDir_Platform_NotForLicensees,</span><br><span class="line">	<span class="comment">// Engine/Config/NoRedist/PlatformName/PlatformName*.ini</span></span><br><span class="line">	EngineDir_Platform_NoRedist,</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Game/Config/PlatformName/PlatformName*.ini</span></span><br><span class="line">	GameDir_Platform,</span><br><span class="line">	<span class="comment">// Game/Config/NotForLicensees/PlatformName/PlatformName*.ini</span></span><br><span class="line">	GameDir_Platform_NotForLicensees,</span><br><span class="line">	<span class="comment">// Game/Config/NoRedist/PlatformName/PlatformName*.ini</span></span><br><span class="line">	GameDir_Platform_NoRedist,</span><br><span class="line"></span><br><span class="line">	<span class="comment">// &lt;UserSettingsDir|AppData&gt;/Unreal Engine/Engine/Config/User*.ini</span></span><br><span class="line">	UserSettingsDir_EngineDir_User,</span><br><span class="line">	<span class="comment">// &lt;UserDir|Documents&gt;/Unreal Engine/Engine/Config/User*.ini</span></span><br><span class="line">	UserDir_User,</span><br><span class="line">	<span class="comment">// Game/Config/User*.ini</span></span><br><span class="line">	GameDir_User,</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Number of config files in hierarchy.</span></span><br><span class="line">	NumHierarchyFiles,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<h2 id="3、ini文件的加载和解析"><a href="#3、ini文件的加载和解析" class="headerlink" title="3、ini文件的加载和解析"></a>3、ini文件的加载和解析</h2><p>&emsp;UE4中，使用类FConfigCacheIni来加载和管理系统中所使用的所有ini文件，可以通过该类来读取和设置ini文件中相应键值对。</p>
<h3 id="3-1-FConfigCacheIni-配置文件系统"><a href="#3-1-FConfigCacheIni-配置文件系统" class="headerlink" title="3.1 FConfigCacheIni-配置文件系统"></a>3.1 FConfigCacheIni-配置文件系统</h3><p>&emsp;首先，我们来看一下FConfigCacheIni类的定义。<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Set of all cached config files.</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CORE_API</span> <span class="title">FConfigCacheIni</span> :</span> <span class="keyword">public</span> TMap&lt;FString,FConfigFile&gt;</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//接口函数已经省略，请自行查看代码</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">	<span class="comment">/** true if file operations should not be performed */</span></span><br><span class="line">	<span class="keyword">bool</span> bAreFileOperationsDisabled;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/** true after the base .ini files have been loaded, and GConfig is generally "ready for use" */</span></span><br><span class="line">	<span class="keyword">bool</span> bIsReadyForUse;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">/** The type of the cache (basically, do we call Flush in the destructor) */</span></span><br><span class="line">	EConfigCacheType Type;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p>&emsp;可以看出,FConfigCacheIni实际上是由一组文件名-配置文件FConfigFile组成的Map加上表征配置文件系统状态和类型的变量bool bAreFileOperationsDisabled、bool bIsReadyForUse、EConfigCacheType Type组成的。<br>&emsp;FConfigCacheIni类的访问具体键值的接口型如：<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> SetInt<span class="comment">//设置整型数值，通过指定ini文件、指定区段、指定键名称，设置该键为int值</span></span><br><span class="line">(</span><br><span class="line">	<span class="keyword">const</span> TCHAR*		Section,<span class="comment">//区段名</span></span><br><span class="line">	<span class="keyword">const</span> TCHAR*		Key,<span class="comment">//键名</span></span><br><span class="line">	int32					Value,<span class="comment">//值</span></span><br><span class="line">	<span class="keyword">const</span> FString&amp;	Filename<span class="comment">//ini文件名</span></span><br><span class="line">);</span><br><span class="line"><span class="keyword">bool</span> GetInt<span class="comment">//通过ini文件名，区段名，键名称获取该键对应的int值</span></span><br><span class="line">(</span><br><span class="line">	<span class="keyword">const</span> TCHAR*		Section,<span class="comment">//区段名</span></span><br><span class="line">	<span class="keyword">const</span> TCHAR*		Key,<span class="comment">//键名</span></span><br><span class="line">	int32&amp;				Value,<span class="comment">//输出int值</span></span><br><span class="line">	<span class="keyword">const</span> FString&amp;	Filename<span class="comment">//ini文件名</span></span><br><span class="line">);</span><br></pre></td></tr></table></figure></p>
<p>&emsp;TConfigCacheIni类还有几个特殊的静态成员函数，用于执行整个配置文件缓存系统的初始化和配置文件的加载工作。<br>&emsp;例如，在static void InitializeConfigSystem()中，完成了全局变量FConfigCacheIni*                GConfig                        = nullptr所指向对象的创建和赋值工作。之后调用LoadGlobalIniFile、LoadExternalIniFile、LoadLocalIniFile、LoadConsoleVariablesFromINI进行ini文件的加载。<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Static helper functions</span></span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">InitializeConfigSystem</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">static</span> <span class="keyword">bool</span> <span class="title">LoadGlobalIniFile</span><span class="params">(FString&amp; FinalIniFilename, <span class="keyword">const</span> TCHAR* BaseIniName, <span class="keyword">const</span> TCHAR* Platform=<span class="literal">NULL</span>, <span class="keyword">bool</span> bForceReload=<span class="literal">false</span>, <span class="keyword">bool</span> bRequireDefaultIni=<span class="literal">false</span>, <span class="keyword">bool</span> bAllowGeneratedIniWhenCooked=<span class="literal">true</span>, <span class="keyword">const</span> TCHAR* GeneratedConfigDir = *FPaths::GeneratedConfigDir())</span></span>;</span><br><span class="line"></span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">static</span> <span class="keyword">bool</span> <span class="title">LoadLocalIniFile</span><span class="params">(FConfigFile&amp; ConfigFile, <span class="keyword">const</span> TCHAR* IniName, <span class="keyword">bool</span> bIsBaseIniName, <span class="keyword">const</span> TCHAR* Platform=<span class="literal">NULL</span>, <span class="keyword">bool</span> bForceReload=<span class="literal">false</span>)</span></span>;</span><br><span class="line"></span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">static</span> <span class="keyword">bool</span> <span class="title">LoadExternalIniFile</span><span class="params">(FConfigFile&amp; ConfigFile, <span class="keyword">const</span> TCHAR* IniName, <span class="keyword">const</span> TCHAR* EngineConfigDir, <span class="keyword">const</span> TCHAR* SourceConfigDir, <span class="keyword">bool</span> bIsBaseIniName, <span class="keyword">const</span> TCHAR* Platform=<span class="literal">NULL</span>, <span class="keyword">bool</span> bForceReload=<span class="literal">false</span>, <span class="keyword">bool</span> bWriteDestIni=<span class="literal">false</span>, <span class="keyword">bool</span> bAllowGeneratedIniWhenCooked = <span class="literal">true</span>, <span class="keyword">const</span> TCHAR* GeneratedConfigDir = *FPaths::GeneratedConfigDir())</span></span>;</span><br><span class="line"></span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">LoadConsoleVariablesFromINI</span><span class="params">()</span></span>;</span><br></pre></td></tr></table></figure></p>
<h3 id="3-2-FConfigFile-配置文件"><a href="#3-2-FConfigFile-配置文件" class="headerlink" title="3.2 FConfigFile-配置文件"></a>3.2 FConfigFile-配置文件</h3><p>&emsp;FConfigFile类用于表示一个ini配置文件。一个ini配置文件可以有多个区段组成，每个区段有自己的名称，因此，一个配置文件至少包含一个名称-区段的映射表。同时，一个配置文件还具有自己的文件名，配置文件类型的属性。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// One config file.</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FConfigFile</span> :</span> <span class="keyword">public</span> TMap&lt;FString,FConfigSection&gt;</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="keyword">bool</span> Dirty, NoSave;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/** The name of this config file */</span>	</span><br><span class="line">	FName Name;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// The collection of source files which were used to generate this file.</span></span><br><span class="line">	FConfigFileHierarchy SourceIniHierarchy;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/** The untainted config file which contains the coalesced base/default options. I.e. No Saved/ options*/</span></span><br><span class="line">	FConfigFile* SourceConfigFile;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/** Key to the cache to speed up ini parsing */</span></span><br><span class="line">	FString CacheKey;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> ALLOW_INI_OVERRIDE_FROM_COMMANDLINE</span></span><br><span class="line">	<span class="comment">/** The collection of overrides which stemmed from the commandline */</span></span><br><span class="line">	TArray&lt;FConfigCommandlineOverride&gt; CommandlineOptions;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">// ALLOW_INI_OVERRIDE_FROM_COMMANDLINE</span></span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>&emsp;通过一个配置文件对象，可以对该对象所表示的配置文件中的值进行读取和写入。读取和写入函数型如：<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">CORE_API <span class="keyword">void</span> <span class="title">SetString</span><span class="params">( <span class="keyword">const</span> TCHAR* Section, <span class="keyword">const</span> TCHAR* Key, <span class="keyword">const</span> TCHAR* Value )</span></span>;</span><br><span class="line"><span class="function">CORE_API <span class="keyword">bool</span> <span class="title">GetString</span><span class="params">( <span class="keyword">const</span> TCHAR* Section, <span class="keyword">const</span> TCHAR* Key, FString&amp; Value )</span> <span class="keyword">const</span></span>;</span><br></pre></td></tr></table></figure></p>
<p>&emsp;与上节中FConfigCacheIni类的接口不同的是，FConfigFile类的接口不在需要指定ini文件名。</p>
<h3 id="3-3-FConfigSection-ini文件中的区段"><a href="#3-3-FConfigSection-ini文件中的区段" class="headerlink" title="3.3 FConfigSection-ini文件中的区段"></a>3.3 FConfigSection-ini文件中的区段</h3><p>&emsp;一个ini文件的区段，是由一组或多组键值对组成的，所以从FConfigSection类是一个由键名称-值组成的映射表。注意它的MultiFind成员函数，从它的实现我们可以看出，UE4的配置文件中，是支持在同一个区段中，一个键的名称对应多个不同的值的，也就是说存在1-N的映射关系。<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> TMultiMap&lt;FName,FConfigValue&gt; FConfigSectionMap;</span><br><span class="line"></span><br><span class="line"><span class="comment">// One section in a config file.</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FConfigSection</span> :</span> <span class="keyword">public</span> FConfigSectionMap</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	* Check whether the input string is surrounded by quotes</span></span><br><span class="line"><span class="comment">	*</span></span><br><span class="line"><span class="comment">	* @param Test The string to check</span></span><br><span class="line"><span class="comment">	*</span></span><br><span class="line"><span class="comment">	* @return true if the input string is surrounded by quotes</span></span><br><span class="line"><span class="comment">	*/</span></span><br><span class="line">	<span class="function"><span class="keyword">static</span> <span class="keyword">bool</span> <span class="title">HasQuotes</span><span class="params">( <span class="keyword">const</span> FString&amp; Test )</span></span>;</span><br><span class="line">	<span class="keyword">bool</span> <span class="keyword">operator</span>==( <span class="keyword">const</span> FConfigSection&amp; Other ) <span class="keyword">const</span>;</span><br><span class="line">	<span class="keyword">bool</span> <span class="keyword">operator</span>!=( <span class="keyword">const</span> FConfigSection&amp; Other ) <span class="keyword">const</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// process the '+' and '.' commands, takingf into account ArrayOfStruct unique keys</span></span><br><span class="line">	<span class="function"><span class="keyword">void</span> CORE_API <span class="title">HandleAddCommand</span><span class="params">(FName Key, <span class="keyword">const</span> FString&amp; Value, <span class="keyword">bool</span> bAppendValueIfNotArrayOfStructsKeyUsed)</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">template</span>&lt;<span class="keyword">typename</span> Allocator&gt; </span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">MultiFind</span><span class="params">(<span class="keyword">const</span> FName Key, TArray&lt;FConfigValue, Allocator&gt;&amp; OutValues, <span class="keyword">const</span> <span class="keyword">bool</span> bMaintainOrder = <span class="literal">false</span>)</span> <span class="keyword">const</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		FConfigSectionMap::MultiFind(Key, OutValues, bMaintainOrder);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">template</span>&lt;<span class="keyword">typename</span> Allocator&gt; </span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">MultiFind</span><span class="params">(<span class="keyword">const</span> FName Key, TArray&lt;FString, Allocator&gt;&amp; OutValues, <span class="keyword">const</span> <span class="keyword">bool</span> bMaintainOrder = <span class="literal">false</span>)</span> <span class="keyword">const</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">const</span> TPair&lt;FName, FConfigValue&gt;&amp; Pair : Pairs)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">if</span> (Pair.Key == Key)</span><br><span class="line">			&#123;</span><br><span class="line">				OutValues.Add(Pair.Value.GetValue());</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (bMaintainOrder)</span><br><span class="line">		&#123;</span><br><span class="line">			Algo::Reverse(OutValues);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// look for "array of struct" keys for overwriting single entries of an array</span></span><br><span class="line">	TMap&lt;FName, FString&gt; ArrayOfStructKeys;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<h3 id="3-4-FConfigValue-配置的值"><a href="#3-4-FConfigValue-配置的值" class="headerlink" title="3.4 FConfigValue-配置的值"></a>3.4 FConfigValue-配置的值</h3><p>&emsp;UE4配置文件系统FConfigCacheIni由多个FConfigFile组成，FConfigFile有多个FConfigSection组成，FConfigSection则由多个FConfigValue组成。FConfigValue是保存配置文件值的字面值的地方，也就意味着，在整个UE4的配置文件系统中，将所有从配置文件中读取的值都保存成了字符串，在需要使用的时候再通过相应的接口转变成所需要的类型，比如int等类型。<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">FConfigValue</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="comment">// Returns the ini setting with any macros expanded out</span></span><br><span class="line">	<span class="function"><span class="keyword">const</span> FString&amp; <span class="title">GetValue</span><span class="params">()</span> <span class="keyword">const</span> </span></span><br><span class="line"><span class="function">	</span>&#123; </span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> WITH_EDITOR</span></span><br><span class="line">		bRead = <span class="literal">true</span>; </span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">		<span class="keyword">return</span> (ExpandedValue.Len() &gt; <span class="number">0</span> ? ExpandedValue : SavedValue); </span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Returns the original ini setting without macro expansion</span></span><br><span class="line">	<span class="function"><span class="keyword">const</span> FString&amp; <span class="title">GetSavedValue</span><span class="params">()</span> <span class="keyword">const</span> </span></span><br><span class="line"><span class="function">	</span>&#123; </span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> WITH_EDITOR</span></span><br><span class="line">		bRead = <span class="literal">true</span>; </span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">		<span class="keyword">return</span> SavedValue; </span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">	<span class="comment">/** Internal version of ExpandValue that expands SavedValue into ExpandedValue, or produces an empty ExpandedValue if no expansion occurred. */</span></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">ExpandValueInternal</span><span class="params">()</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (!ExpandValue(SavedValue, ExpandedValue))</span><br><span class="line">		&#123;</span><br><span class="line">			ExpandedValue.Empty();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	FString SavedValue;</span><br><span class="line">	FString ExpandedValue;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> WITH_EDITOR</span></span><br><span class="line">	<span class="keyword">mutable</span> <span class="keyword">bool</span> bRead; <span class="comment">// has this value been read since the config system started</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p>&emsp;从中可以看出，FConfigValue保存的是FString类型的字符串。</p>
<h2 id="4、UE4配置系统结构图"><a href="#4、UE4配置系统结构图" class="headerlink" title="4、UE4配置系统结构图"></a>4、UE4配置系统结构图</h2><p><img src="/2018/10/28/UE4源代码分析/【UE4源代码分析】-002 UE4中的配置文件/【UE4源代码分析】-002 UE4中的配置文件/002-01配置文件系统结构.png" alt="image"></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2018/10/28/UE4源代码分析/【UE4源代码分析】-002 UE4中的配置文件/【UE4源代码分析】-002 UE4中的配置文件/" data-id="cjnroz8p200056l9sq3uo3s5x" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-UE4源代码分析/【UE4源代码分析】-004 读写锁/【UE4源代码分析】-004 读写锁" class="article article-type-post" itemscope="" itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/10/28/UE4源代码分析/【UE4源代码分析】-004 读写锁/【UE4源代码分析】-004 读写锁/" class="article-date">
  <time datetime="2018-10-27T16:34:35.000Z" itemprop="datePublished">2018-10-28</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/10/28/UE4源代码分析/【UE4源代码分析】-004 读写锁/【UE4源代码分析】-004 读写锁/">【UE4源代码分析】-004 读写锁</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="1、读写锁"><a href="#1、读写锁" class="headerlink" title="1、读写锁"></a>1、读写锁</h2><p>&emsp;&emsp;在上一篇中讨论临界区时，我们发现临界区虽然实现了对临界资源的保护，但同时也使所有对临界资源的访问都变成了串行的请求。实际上，线程请求临界资源之后可以分成两种行为，一种是读操作，另一种是写操作。当多个读操作同时进行时，不会发生资源被修改的问题，多个读操作时可以并行进行的。但多个写操作或者写操作和读操作之间，由于可能在写操作的过程中发生中断行为，或者读操作的过程中发生中断，导致数据被写操作修改，因此，多个写操作或写操作与读操作之间不能同时进行。<br>&emsp;&emsp;为了使多个读操作能够并行处理同时保持写操作的独占性，产生了读写锁。<br>&emsp;&emsp;在Vista之后，windows系统中出现了<code>SRWLock</code>对象。<code>SRWLock</code>是微软对读写锁的一个实现方案。</p>
<h2 id="2、windows读写锁"><a href="#2、windows读写锁" class="headerlink" title="2、windows读写锁"></a>2、windows读写锁</h2><p>&emsp;&emsp;我们先来看一看MSDN上微软对<code>SRWLock</code>的描述。</p>
<blockquote>
<p>Slim Reader/Writer (SRW) Locks</p>
<p><strong>Slim reader/writer (SRW) locks</strong> enable <strong>the threads of a single process</strong> to access shared resources; they are optimized for speed and occupy very little memory. Slim reader-writer locks <strong>cannot be shared across processes</strong>.</p>
<p>Reader threads read data from a shared resource whereas writer threads write data to a shared resource. When multiple threads are reading and writing using a shared resource, exclusive locks such as a critical section or mutex can become a bottleneck if the reader threads run continuously but write operations are rare.</p>
<p>SRW locks provide two modes in which threads can access a shared resource:</p>
<p>   Shared mode, which grants shared read-only access to multiple reader threads, which enables them to read data from the shared resource concurrently. If read operations exceed write operations, this concurrency increases performance and throughput compared to critical sections.<br>   Exclusive mode, which grants read/write access to one writer thread at a time. When the lock has been acquired in exclusive mode, no other thread can access the shared resource until the writer releases the lock.</p>
<p>A single SRW lock can be acquired in either mode; reader threads can acquire it in shared mode whereas writer threads can acquire it in exclusive mode. There is no guarantee about the order in which threads that request ownership will be granted ownership; SRW locks are neither fair nor FIFO.</p>
<p>An SRW lock is the size of a pointer. The advantage is that it is fast to update the lock state. The disadvantage is that very little state information can be stored, so SRW locks cannot be acquired recursively. In addition, a thread that owns an SRW lock in shared mode cannot upgrade its ownership of the lock to exclusive mode.</p>
<p>The caller must allocate an SRWLOCK structure and initialize it by either calling InitializeSRWLock (to initialize the structure dynamically) or assign the constant SRWLOCK_INIT to the structure variable (to initialize the structure statically).</p>
<p>The following are the SRW lock functions.</p>
<blockquote>
<table>
<thead>
<tr>
<th>SRW lock function</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>AcquireSRWLockExclusive</td>
<td>Acquires an SRW lock in exclusive mode.</td>
</tr>
<tr>
<td>AcquireSRWLockShared</td>
<td>Acquires an SRW lock in shared mode.</td>
</tr>
<tr>
<td>InitializeSRWLock</td>
<td>Initialize an SRW lock.</td>
</tr>
<tr>
<td>ReleaseSRWLockExclusive</td>
<td>Releases an SRW lock that was opened in exclusive mode.</td>
</tr>
<tr>
<td>ReleaseSRWLockShared</td>
<td>Releases an SRW lock that was opened in shared mode.</td>
</tr>
<tr>
<td>SleepConditionVariableSRW</td>
<td>Sleeps on the specified condition variable and releases the specified lock as an atomic operation.</td>
</tr>
<tr>
<td>TryAcquireSRWLockExclusive</td>
<td>Attempts to acquire a slim reader/writer (SRW) lock in exclusive mode. If the call is successful, the calling thread takes ownership of the lock.</td>
</tr>
<tr>
<td>TryAcquireSRWLockShared</td>
<td>Attempts to acquire a slim reader/writer (SRW) lock in shared mode. If the call is successful, the calling thread takes ownership of the lock. </td>
</tr>
</tbody>
</table>
<p>&emsp;&emsp;从上面的介绍可以看出，<code>SRWLock</code>只能用于单个进程的多个线程之间进行资源同步，不能用于多个进程间的资源同步。<code>SRWLock</code>将线程分为两中模式——共享模式和独占模式。<strong>共享模式</strong>允许多个读线程同时对临界资源进行访问，当读线程数目比写线程多时，<code>SRWLock</code>与临界区相比，具有更高的效率。<strong>独占模式</strong>下，线程将独占临界资源，当临界资源处于独占模式下时，其余线程不能访问临界资源<strong>直到</strong>写线程结束对资源的访问。<br>&emsp;&emsp;<code>SRWLock</code>本身不提供优先级判断，既不是公平锁也不是FIFO。<br>&emsp;&emsp;<code>SRWLock</code>的大小仅仅为一个指针大小，好处是能够高效地改变锁的状态，坏处是只能保存少量的锁的状态信息。所以<code>SRWLock</code>锁不能被递归获取，并且已经使用共享模式获取锁的线程也不能修改自己的状态到独占模式。<br>&emsp;&emsp;使用上表中所列出的接口函数，用户可以创建读写锁，并对读写锁进行共享模式和独占模式的加锁与释放操作。<br>&emsp;&emsp;<strong>注意</strong>，系统并没有提供销毁读写锁的接口。</p>
</blockquote>
</blockquote>
<h2 id="3、UE4中的读写锁"><a href="#3、UE4中的读写锁" class="headerlink" title="3、UE4中的读写锁"></a>3、UE4中的读写锁</h2><p>&emsp;&emsp;UE中，对Windows提供的读写锁进行了封装，提供了<code>FWindowsRWLock</code>类。<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * FWindowsRWLock - Read/Write Mutex</span></span><br><span class="line"><span class="comment"> *	- Provides non-recursive Read/Write (or shared-exclusive) access.</span></span><br><span class="line"><span class="comment"> *	- Windows specific lock structures/calls Ref: https://msdn.microsoft.com/en-us/library/windows/desktop/aa904937(v=vs.85).aspx</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FWindowsRWLock</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="function">FORCEINLINE <span class="title">FWindowsRWLock</span><span class="params">(uint32 Level = <span class="number">0</span>)</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		Windows::InitializeSRWLock(&amp;Mutex);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	FORCEINLINE ~FWindowsRWLock()</span><br><span class="line">	&#123;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//共享模式加锁</span></span><br><span class="line">	<span class="function">FORCEINLINE <span class="keyword">void</span> <span class="title">ReadLock</span><span class="params">()</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		Windows::AcquireSRWLockShared(&amp;Mutex);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//独占模式加锁</span></span><br><span class="line">	<span class="function">FORCEINLINE <span class="keyword">void</span> <span class="title">WriteLock</span><span class="params">()</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		Windows::AcquireSRWLockExclusive(&amp;Mutex);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//共享模式解锁</span></span><br><span class="line">	<span class="function">FORCEINLINE <span class="keyword">void</span> <span class="title">ReadUnlock</span><span class="params">()</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		Windows::ReleaseSRWLockShared(&amp;Mutex);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//独占模式解锁</span></span><br><span class="line">	<span class="function">FORCEINLINE <span class="keyword">void</span> <span class="title">WriteUnlock</span><span class="params">()</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		Windows::ReleaseSRWLockExclusive(&amp;Mutex);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">	Windows::SRWLOCK Mutex;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p>&emsp;&emsp;从上面的实现可以看出，<code>FWindowsRWLock</code>类是对<code>Windows::SRWLOCK</code>的封装，并提供了创建(<code>FWindowsRWLock()</code>)接口，共享模式操作(<code>FORCEINLINE void ReadLock()</code>共享模式加锁，<code>FORCEINLINE void ReadUnlock()</code>共享模式解锁)接口，独占模式操作(<code>FORCEINLINE void WriteLock()</code>独占模式加锁,<code>FORCEINLINE void WriteUnlock()</code>独占模式解锁)接口。<br>&emsp;&emsp;从使用上来看，FWindowsRWLock在对象构造的时候创建windows::SRWLock，之后的操作都通过封装的接口操作。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2018/10/28/UE4源代码分析/【UE4源代码分析】-004 读写锁/【UE4源代码分析】-004 读写锁/" data-id="cjnroz8p400086l9sf2s81she" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-UE4源代码分析/【UE4源代码分析】-006 检查程序是否是第一个实例/【UE4源代码分析】-006 检查程序是否是第一个实例" class="article article-type-post" itemscope="" itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/10/28/UE4源代码分析/【UE4源代码分析】-006 检查程序是否是第一个实例/【UE4源代码分析】-006 检查程序是否是第一个实例/" class="article-date">
  <time datetime="2018-10-27T16:34:35.000Z" itemprop="datePublished">2018-10-28</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/10/28/UE4源代码分析/【UE4源代码分析】-006 检查程序是否是第一个实例/【UE4源代码分析】-006 检查程序是否是第一个实例/">【UE4源代码分析】-006 检查程序是否是第一个实例</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>&emsp;&emsp;本文主要结合在工作中遇到的需要保持在一台计算机上只允许一个程序实例运行的需求，结合在阅读UE4源代码的时候关于<code>NamedMutex</code>的一点思考，记录下如果检测程序是否是本计算机上运行的第一个实例的问题。</p>
<p>[TOC]</p>
<h2 id="1、问题的由来"><a href="#1、问题的由来" class="headerlink" title="1、问题的由来"></a>1、问题的由来</h2><p>&emsp;&emsp;最近在开发过程中，由于软件需要和计算机的数据采集卡硬件打交道，数据采集卡SDK在重复初始化的时候会初始化失败。虽然在初始化失败的时候回弹出窗口并退出程序，但在客户体验来说有点low。<br>&emsp;&emsp;由于我平时是网易云音乐的用户，在使用网易云音乐的时候发现，当在一台计算机上已经运行了一个客户端的情况下，第二次启动网易云音乐的请求会直接把第一个程序实例的主界面显示出来，既响应了用户的运行请求，又不会弹出警告框影响用户体验。<br>&emsp;&emsp;这两件事的内在都是程序开始运行之后，如何检测自己是不是第一个运行的该应用程序的实例。</p>
<h2 id="2、UE4的启发"><a href="#2、UE4的启发" class="headerlink" title="2、UE4的启发"></a>2、UE4的启发</h2><p>&emsp;&emsp;在上一篇<strong>【UE4源代码分析】-005 Editor的起点-Main函数</strong>中，在分析UE4编辑器的启动过程中，发现<code>WinMain</code>函数在设置了windows环境之后，紧接着就进行的工作是<code>GIsFirstInstance = MakeNamedMutex( CmdLine )</code>。在<code>MakeNamedMutex</code>函数中，主要进行了以下操作：<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">MakeNamedMutex</span><span class="params">( <span class="keyword">const</span> TCHAR* CmdLine )</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">bool</span> bIsFirstInstance = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">	TCHAR MutexName[MAX_SPRINTF] = TEXT( <span class="string">""</span> );</span><br><span class="line"></span><br><span class="line">	FCString::Strcpy( MutexName, MAX_SPRINTF, TEXT( <span class="string">"UnrealEngine4"</span> ) );</span><br><span class="line"></span><br><span class="line">	GNamedMutex = CreateMutex( <span class="literal">NULL</span>, <span class="literal">true</span>, MutexName );</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span>( GNamedMutex	&amp;&amp; GetLastError() != ERROR_ALREADY_EXISTS &amp;&amp; !FParse::Param( CmdLine, TEXT( <span class="string">"NEVERFIRST"</span> ) ) )</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">// We're the first instance!</span></span><br><span class="line">		bIsFirstInstance = <span class="literal">true</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">// Still need to release it in this case, because it gave us a valid copy</span></span><br><span class="line">		ReleaseNamedMutex();</span><br><span class="line">		<span class="comment">// There is already another instance of the game running.</span></span><br><span class="line">		bIsFirstInstance = <span class="literal">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span>( bIsFirstInstance );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>&emsp;&emsp;程序的流程如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">st=&gt;start: 开始</span><br><span class="line">e=&gt;end: 结束</span><br><span class="line">InitVaribale=&gt;operation: 设置内部变量状态</span><br><span class="line">CreateMutex=&gt;operation: 创建命名Mutex</span><br><span class="line">SetReturnValueTrue=&gt;operation: 设置返回值状态True</span><br><span class="line">SetReturnValueFalse=&gt;operation: 设置返回值状态False</span><br><span class="line">ReleaseMutex=&gt;operation: 释放Mutex Handle</span><br><span class="line">cond1=&gt;condition: Handle是否有效</span><br><span class="line">cond2=&gt;condition: Mutex是否已经存在</span><br><span class="line">cond3=&gt;condition: 带NEVERFIRST参数</span><br><span class="line"></span><br><span class="line">st-&gt;InitVaribale-&gt;CreateMutex-&gt;cond1</span><br><span class="line">cond1(yes)-&gt;cond2</span><br><span class="line">cond1(no)-&gt;ReleaseMutex</span><br><span class="line">cond2(yes)-&gt;cond3</span><br><span class="line">cond2(no)-&gt;ReleaseMutex</span><br><span class="line">cond3(yes)-&gt;SetReturnValueTrue</span><br><span class="line">cond3(no)-&gt;ReleaseMutex</span><br><span class="line">ReleaseMutex-&gt;SetReturnValueFalse</span><br><span class="line">SetReturnValueFalse-&gt;e</span><br><span class="line">SetReturnValueTrue-&gt;e</span><br></pre></td></tr></table></figure></p>
<p>图1 UE4启动过程CreateNamedMutex流程图</p>
<p>&emsp;&emsp;<strong>Mutex的性质</strong></p>
<ul>
<li>Mutex是系统内核的对象，可以用于线程或进程之间的同步；</li>
<li>Mutex是互斥体，同一时刻只有多个线程或进程中的一个拥有该对象；</li>
<li>Mutex分为命名互斥体和未命名互斥体两类；</li>
<li>未命名互斥体只能用于单个进程的多个线程之间同步资源；</li>
<li>命名的互斥体可以用于不同进程之间同步资源。<br>&emsp;&emsp;从以上性质可以看出，当程序的第一个实例开始运行的时候，调用<code>CreateMutex</code>创建一个命名的互斥体，之后的程序实例视图调用<code>CreateMutex</code>创建命名互斥体的时候由于已经存在该名称的互斥体，所以<code>CreateMutex</code>调用会设置最近错误为<code>ERROR_ALREADY_EXISTS</code>，表示该互斥体已经存在。通过该错误即可检测程序是不是第一个运行的实例。<h2 id="3、实现"><a href="#3、实现" class="headerlink" title="3、实现"></a>3、实现</h2>&emsp;&emsp;本文使用命名Mutex+计数变量的形式来记录程序的运行次数。</li>
<li>新建MFC对话框项目<br>&emsp;&emsp;建议带上最大化最小化按钮，方便演示类似网易云音乐的第二次运行直接弹出第一次运行窗口的功能。<br>&emsp;&emsp;本文中工程名为<em>IsFirstRun</em>，VS自动生成IsFirstRun.h,IsFirstRun.cpp,IsFirstRunDlg.h,IsFirstRunDlg.cpp等文件。</li>
<li>定义全局资源<br>&emsp;&emsp;在IsFirstRunApp.cpp,定义全局变量：<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">HANDLE g_hMutex = <span class="literal">NULL</span>;</span><br><span class="line"><span class="keyword">const</span> CString g_cstrMutexName = <span class="string">L"IsFirstRunMutex"</span>;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>&emsp;&emsp;其中<code>g_cstrMutexName</code>表示我们要命名的Mutex对象名称。<br>&emsp;&emsp;在窗口上放置一个static text控件，并将空间ID改为IDC_SHOW_MSG.</p>
<ul>
<li>创建命名Mutex<br>&emsp;&emsp;在<code>CIsFirstRunApp()</code>中添加代码：<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">   <span class="comment">//尝试创建命名Mutex对象</span></span><br><span class="line">g_hMutex = CreateMutex(<span class="literal">NULL</span>, FALSE, g_cstrMutexName);</span><br><span class="line"><span class="keyword">if</span> (g_hMutex &amp;&amp; ERROR_ALREADY_EXISTS == GetLastError())</span><br><span class="line">&#123;<span class="comment">//命名Mutex已经存在</span></span><br><span class="line">       <span class="comment">//通过程序名称查找窗口</span></span><br><span class="line">	CWnd* pWnd = CWnd::FindWindow(<span class="literal">NULL</span>, _T(<span class="string">"IsFirstRun"</span>));</span><br><span class="line">	<span class="comment">//向该窗口发送自定义消息</span></span><br><span class="line">       SendMessage(pWnd-&gt;GetSafeHwnd(), WM_USER + <span class="number">1001</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">	<span class="comment">//此时仍然需要释放该Mutex HANDLE</span></span><br><span class="line">       ReleaseMutex(g_hMutex);</span><br><span class="line">       <span class="comment">//退出程序</span></span><br><span class="line">	<span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>&emsp;&emsp;之所以在<code>CIsFirstRunApp()</code>构造函数中进行命名Mutex的创建，是为了对原有程序实例产生尽量小的影响，实际上这个创建过程可以放到Dlg的OnInitDlg中进行。<br>&emsp;&emsp;此处创建失败的处理过程是向已经运行的程序实例发送了一个自定义消息WM_USER+1001。因此，需要添加对这个自定义消息的处理。</p>
<ul>
<li>自定义消息的处理<br>&emsp;&emsp;在IsFirstRunDlg.h中添加消息响应函数声明：<br><code>afx_msg LRESULT OnSencodRun(WPARAM, LPARAM);</code><br>并添加用于记录程序运行次数的成员变量：<code>int m_nRunTimes;</code>并初始化值为1.<br>在<code>BOOL CIsFirstRunDlg::OnInitDialog()</code>中设置显示信息的初始值：<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">CString <span class="title">str</span><span class="params">(<span class="string">L"本程序第1次运行！"</span>)</span></span>;</span><br><span class="line">GetDlgItem(IDC_SHOW_MSG)-&gt;SetWindowTextW(str);</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>&emsp;&emsp;在IsFirstRunDlg.cpp中的消息映射表中添加自定义消息的消息映射：<br><code>ON_MESSAGE(WM_USER+1001,&amp;CIsFirstRunDlg::OnSencodRun)</code><br>&emsp;&emsp;实现<code>CIsFirstRunDlg::OnSencodRun</code>函数：<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">LRESULT CIsFirstRunDlg::OnSencodRun(WPARAM, LPARAM)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//运行次数累加</span></span><br><span class="line">	m_nRunTimes += <span class="number">1</span>;</span><br><span class="line">	CString temp;</span><br><span class="line">	temp.Format(<span class="string">L"本程序第%d次运行！"</span>, m_nRunTimes);</span><br><span class="line">	<span class="comment">//设置界面上程序运行次数提示</span></span><br><span class="line">    GetDlgItem(IDC_SHOW_MSG)-&gt;SetWindowTextW(temp);</span><br><span class="line">	<span class="comment">//显示主窗口</span></span><br><span class="line">    ShowWindow(SW_SHOWNORMAL);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<ul>
<li><p>窗口关闭时释放Mutex<br>&emsp;&emsp;由于命名Mutex是系统核心对象，如果程序退出时不关闭该对象，系统不会自动清理并关闭该对象，因此，需要在程序退出时手动关闭该对象。<br>&emsp;&emsp;我们可以选择在窗口关闭的时候关闭该对象。<br>&emsp;&emsp;为窗口添加WM_CLOSE消息响应函数，并在其中释放Mutex。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> CIsFirstRunDlg::OnClose()</span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">// <span class="doctag">TODO:</span> 在此添加消息处理程序代码和/或调用默认值</span></span><br><span class="line">	<span class="keyword">if</span> (g_hMutex)</span><br><span class="line">	&#123;</span><br><span class="line">		ReleaseMutex(g_hMutex);</span><br><span class="line">		g_hMutex = <span class="literal">NULL</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	CDialogEx::OnClose();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>运行效果<br>&emsp;&emsp;程序第一次运行时效果图如下：<br><img src="/2018/10/28/UE4源代码分析/【UE4源代码分析】-006 检查程序是否是第一个实例/【UE4源代码分析】-006 检查程序是否是第一个实例/IsFirstRun-1.PNG"></p>

<p>&emsp;&emsp;程序第二次运行时效果图如下：<br><img src="/2018/10/28/UE4源代码分析/【UE4源代码分析】-006 检查程序是否是第一个实例/【UE4源代码分析】-006 检查程序是否是第一个实例/IsFirstRun-2.PNG"><br>&emsp;&emsp;如果第二次程序尝试启动时，第一次运行的程序已经处于最小化状态，尝试第二次运行程序会将第一次运行程序的主界面显示出来。</p>
</li>
</ul>
<h2 id="4、总结"><a href="#4、总结" class="headerlink" title="4、总结"></a>4、总结</h2><p>&emsp;&emsp;检测程序是否是第一个运行实例或者是检测程序是第几个运行实例本质上是一个进程间通信的问题，只需要在程序启动的时候去检测特定位置的资源状态即可。<br>&emsp;&emsp;实际上，除了使用系统的命名核心对象之外，我们还可以采用诸如硬盘文件、系统注册表等手段记录程序运行次数，在程序启动时检测该值得出程序的运行次数。</p>
<p>PS：WIN10 + VS2015工程，<br>代码地址：<a href="https://github.com/freehawkzk/IsFirstRun.git" target="_blank" rel="noopener">https://github.com/freehawkzk/IsFirstRun.git</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2018/10/28/UE4源代码分析/【UE4源代码分析】-006 检查程序是否是第一个实例/【UE4源代码分析】-006 检查程序是否是第一个实例/" data-id="cjnroz8p300076l9s0c2c6phg" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-Ubuntu-notes-md" class="article article-type-post" itemscope="" itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/10/28/Ubuntu-notes-md/" class="article-date">
  <time datetime="2018-10-27T16:24:37.000Z" itemprop="datePublished">2018-10-28</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/10/28/Ubuntu-notes-md/">Ubuntu18.04笔记</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="1-将主目录下文件夹名称改成英文名"><a href="#1-将主目录下文件夹名称改成英文名" class="headerlink" title="1 将主目录下文件夹名称改成英文名"></a>1 将主目录下文件夹名称改成英文名</h2><p>&emsp;&emsp;首先修改现有主文件夹下各文件夹名称：</p>
<p>&emsp;&emsp;Desktop、 Documents、 Download、 Music、 Pictures、 Public、 Templates、 Videos ……</p>
<p>&emsp;&emsp;然后编辑配置文件：</p>
<p><code>gedit ~/.config/user-dirs.dirs</code></p>
<p>&emsp;&emsp;把文件夹指向改掉，例如：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">XDG_DESKTOP_DIR=&quot;$HOME/Desktop&quot;</span><br><span class="line"></span><br><span class="line">XDG_DOWNLOAD_DIR=&quot;$HOME/Download&quot;</span><br><span class="line"></span><br><span class="line">XDG_TEMPLATES_DIR=&quot;$HOME/Templates&quot;</span><br><span class="line"></span><br><span class="line">XDG_PUBLICSHARE_DIR=&quot;$HOME/Public&quot;</span><br><span class="line"></span><br><span class="line">XDG_DOCUMENTS_DIR=&quot;$HOME/Documents&quot;</span><br><span class="line"></span><br><span class="line">XDG_MUSIC_DIR=&quot;$HOME/Music&quot;</span><br><span class="line"></span><br><span class="line">XDG_PICTURES_DIR=&quot;$HOME/Pictures&quot;</span><br><span class="line"></span><br><span class="line">XDG_VIDEOS_DIR=&quot;$HOME/Videos&quot;</span><br></pre></td></tr></table></figure></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2018/10/28/Ubuntu-notes-md/" data-id="cjnroz8ne00016l9s5i0fwowj" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-001-VS2015-error-LNK2001-无法解析的外部符号-WinMain-16" class="article article-type-post" itemscope="" itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/10/28/001-VS2015-error-LNK2001-无法解析的外部符号-WinMain-16/" class="article-date">
  <time datetime="2018-10-27T16:24:36.000Z" itemprop="datePublished">2018-10-28</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/10/28/001-VS2015-error-LNK2001-无法解析的外部符号-WinMain-16/">001- VS2015 error LNK2001 无法解析的外部符号 _WinMain@16</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>[TOC]</p>
<h2 id="1、现象"><a href="#1、现象" class="headerlink" title="1、现象"></a>1、现象</h2><p>&emsp;&emsp;使用VS2015新建控制台空项目，之后往项目中手动添加cpp文件，编译时出现<code>error LNK2001 无法解析的外部符号 _WinMain@16</code>错误，链接错误。</p>
<h2 id="2、解决方法"><a href="#2、解决方法" class="headerlink" title="2、解决方法"></a>2、解决方法</h2><p>&emsp;&emsp; (1) 项目属性-&gt;C/C++-&gt;预处理器，预处理器定义中删除<code>_WINDOWS</code>,添加<code>_CONSOLE</code>;<br>&emsp;&emsp; (2) 项目属性-&gt;链接器-&gt;系统，子系统选项选择为<code>控制台 (/SUBSYSTEM:CONSOLE)</code>;</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2018/10/28/001-VS2015-error-LNK2001-无法解析的外部符号-WinMain-16/" data-id="cjnroz8n900006l9sarqn5wff" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  


  <nav id="page-nav">
    
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/">Next &raquo;</a>
  </nav>

</section>
        
          <aside id="sidebar">
  
    

  
    

  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/10/">October 2018</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2018/10/28/UE4源代码分析/【UE4源代码分析】-003 临界区/【UE4源代码分析】-003 临界区/">【UE4源代码分析】-003 临界区</a>
          </li>
        
          <li>
            <a href="/2018/10/28/UE4源代码分析/【UE4源代码分析】-007 仿UE4使用ADO进行数据库操作/【UE4源代码分析】-007 仿UE4使用ADO进行数据库操作/">【UE4源代码分析】-007 仿UE4使用ADO进行数据库操作</a>
          </li>
        
          <li>
            <a href="/2018/10/28/UE4源代码分析/【UE4源代码分析】-009 寻找UE4的D3D设备/【UE4源代码分析】-009 寻找UE4的D3D设备/">【UE4源代码分析】-009 寻找UE4的D3D设备</a>
          </li>
        
          <li>
            <a href="/2018/10/28/UE4源代码分析/【UE4源代码分析】-008 从GuardedMain函数开始/【UE4源代码分析】-008 从GuardedMain函数开始/">【UE4源代码分析】-008 从GuardedMain函数开始游戏循环</a>
          </li>
        
          <li>
            <a href="/2018/10/28/UE4源代码分析/【UE4源代码分析】-005 Editor的起点-Main函数/【UE4源代码分析】-005 Editor的起点-Main函数/">【UE4源代码分析】-005 Editor的起点-Main函数</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2018 John Doe<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>



  </div>
</body>
</html>